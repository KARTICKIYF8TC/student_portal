<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Taker - QR Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D1117;
            color: #f0f6fc;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        #scanner-container {
            display: none; /* Hidden until admin is verified */
            width: 100%;
            max-width: 600px;
            text-align: center;
        }
        #video-container {
            position: relative;
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #qr-video {
            width: 100%;
            height: auto;
            display: block;
        }
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .scanner-overlay .corner {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 5px solid #A855F7;
        }
        .scanner-overlay .top-left { top: 20px; left: 20px; border-right: none; border-bottom: none; }
        .scanner-overlay .top-right { top: 20px; right: 20px; border-left: none; border-bottom: none; }
        .scanner-overlay .bottom-left { bottom: 20px; left: 20px; border-right: none; border-top: none; }
        .scanner-overlay .bottom-right { bottom: 20px; right: 20px; border-left: none; border-top: none; }

        #scan-result {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            width: 100%;
            text-align: center;
            min-height: 70px;
        }
        .alert-success {
            background-color: rgba(40, 167, 69, 0.8);
            color: white;
            border: none;
        }
        .alert-danger {
            background-color: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
        }
         .alert-info {
            background-color: rgba(13, 110, 253, 0.8);
            color: white;
            border: none;
        }
        .alert-initial {
            background-color: rgba(22, 27, 34, 0.8);
            color: #f0f6fc;
            border: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>

    <div id="scanner-container">
        <h1 class="mb-4">QR Code Attendance Scanner</h1>
        <div id="video-container">
            <video id="qr-video" playsinline></video>
            <div class="scanner-overlay">
                <div class="corner top-left"></div>
                <div class="corner top-right"></div>
                <div class="corner bottom-left"></div>
                <div class="corner bottom-right"></div>
            </div>
        </div>
    </div>
    
    <div id="scan-result" class="alert alert-initial" role="alert">
        Verifying admin access...
    </div>
    
    <a href="admin.html" class="btn btn-secondary mt-4">Back to Admin Panel</a>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/+esm";

        const firebaseConfig = {
            apiKey: "AIzaSyDxkvvObHv2IuKMKlp81WVsAtm75gkWB0Y",
            authDomain: "studentportal-eb425.firebaseapp.com",
            projectId: "studentportal-eb425",
            storageBucket: "studentportal-eb425.appspot.com",
            messagingSenderId: "1021027397198",
            appId: "1:1021027397198:web:7195716ef430ebfb359d1f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const videoElem = document.getElementById('qr-video');
        const scanResultElem = document.getElementById('scan-result');
        const scannerContainer = document.getElementById('scanner-container');
        let lastScanTime = 0;
        let lastScannedId = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const adminRef = doc(db, "admins", user.uid);
                const adminSnap = await getDoc(adminRef);

                if (adminSnap.exists()) {
                    scannerContainer.style.display = 'block';
                    showResult('Point the camera at a student\'s QR code.', 'initial');
                    startScanner();
                } else {
                    showResult('Access Denied. You must be an admin to use the scanner.', 'danger');
                }
            } else {
                showResult('Please log in as an admin to use the attendance scanner.', 'danger');
            }
        });

        const onScanSuccess = async (result) => {
            const currentTime = Date.now();
            if (currentTime - lastScanTime < 5000) { 
                return;
            }
            lastScanTime = currentTime;
            
            const studentId = result.data;
            if (lastScannedId === studentId) return;
            lastScannedId = studentId;

            console.log(`Scanned Student ID: ${studentId}`);
            
            try {
                const studentDataRef = doc(db, "studentData", studentId);
                const studentSnap = await getDoc(studentDataRef);

                if (!studentSnap.exists()) {
                    showResult(`Student with ID ${studentId} not found.`, 'danger');
                    return;
                }
                
                const studentData = studentSnap.data();
                const today = new Date();
                const dateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                
                // --- MODIFIED: Check for late arrival ---
                const cutoffTime = new Date();
                cutoffTime.setHours(10, 0, 0, 0); // 10:00 AM
                const attendanceStatus = today > cutoffTime ? 'late' : 'present';

                const attendanceRef = doc(db, "studentAttendance", studentId);
                const updatePath = `records.${dateString}`;
                
                await updateDoc(attendanceRef, { [updatePath]: attendanceStatus });
                
                // --- MODIFIED: Show different success message for late vs present ---
                if (attendanceStatus === 'late') {
                    showResult(`Success! ${studentData.displayName || 'Student'} marked as LATE.`, 'info');
                } else {
                    showResult(`Success! ${studentData.displayName || 'Student'} marked as present.`, 'success');
                }
                
                const updatedAttendanceSnap = await getDoc(attendanceRef);
                const records = updatedAttendanceSnap.data().records || {};
                let presentCount = 0;
                let workingDays = 0;
                for(const dateStr in records) {
                    const recordDate = new Date(dateStr + 'T00:00:00');
                    if (recordDate <= today) {
                        // --- MODIFIED: Count 'late' as present for percentage ---
                        if (records[dateStr] === 'present' || records[dateStr] === 'late') presentCount++;
                        if (records[dateStr] !== 'holiday') workingDays++;
                    }
                }
                const attendancePercent = workingDays > 0 ? Math.round((presentCount / workingDays) * 100) : 0;
                await updateDoc(studentDataRef, { attendance: attendancePercent });

            } catch (error) {
                console.error("Error updating attendance: ", error);
                showResult(`Error: ${error.message}`, 'danger');
            } finally {
                setTimeout(() => { lastScannedId = null; }, 5000);
            }
        };

        const showResult = (message, type) => {
            scanResultElem.textContent = message;
            scanResultElem.className = `alert alert-${type}`;
        };

        function startScanner() {
            const qrScanner = new QrScanner(videoElem, onScanSuccess, {
                highlightScanRegion: true,
                highlightCodeOutline: true,
            });

            qrScanner.start().catch(err => {
                console.error(err);
                showResult('Could not start camera. Please grant permission and refresh the page.', 'danger');
            });
        }
    </script>
</body>
</html>