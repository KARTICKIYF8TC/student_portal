<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Panel - Student Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #c5cbd9;
      --bg-secondary: #6f8098;
      --border-color: #374151;
      --text-primary: #030209;
      --text-secondary: #1b212b;
      --accent-primary: #2e3c51;
      --accent-hover: #2563EB;
      --danger-primary: #EF4444;
      --danger-hover: #DC2626;
      --success-primary: #22C55E;
    }
    .text-white {
    --bs-text-opacity: 1;
    color: #000 !important;
}
    .text-secondary {
    --bs-text-opacity: 1;
    color: rgb(7 7 7) !important;
}
    body { 
      font-family: 'Inter', sans-serif; 
      color: var(--text-primary);
      background-color: var(--bg-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    html, body {
  height: 100%;
}

#main-content,
.main-container,
.main-container .row {
  height: 100%;
  display: flex;
}

.sidebar {
  min-height: 100vh; /* ensures full vertical stretch */
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}


    #main-content {
        display: none;
        flex-direction: column;
        flex-grow: 1;
    }

    .sidebar, .offcanvas {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      border-right: 1px solid var(--border-color);
    }
    
    .sidebar .list-group-item-action, .offcanvas .list-group-item-action {
        background-color: transparent;
        border: none;
        color: var(--text-secondary);
        border-radius: .5rem;
        font-weight: 500;
        transition: background-color 0.2s ease, color 0.2s ease;
    }

    .sidebar .list-group-item-action:hover {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
    }

    .sidebar .list-group-item-action.active, .offcanvas .list-group-item-action.active {
        background-color: var(--accent-primary);
        color: var(--text-primary);
    }

    #mainNavbar {
      background-color: var(--bg-primary) !important;
      border-bottom: 1px solid var(--border-color);
    }

    .modal-content {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        border-radius: 0.75rem;
    }
    .modal-header, .modal-footer {
        border-color: var(--border-color);
    }
    .btn-close { 
        filter: invert(1) grayscale(100%) brightness(200%); 
    }

    .form-control, .form-select, textarea {
      background-color: var(--bg-primary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border-radius: 0.5rem;
    }
    .form-control:focus, .form-select:focus, textarea:focus {
      background-color: var(--bg-primary);
      border-color: var(--accent-primary);
      color: var(--text-primary);
      box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25);
    }
    .form-select option {
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }

    /* THE DEFINITIVE AUTOFILL FIX */
    input:-webkit-autofill,
    input:-webkit-autofill:hover, 
    input:-webkit-autofill:focus, 
    input:-webkit-autofill:active {
        -webkit-text-fill-color: var(--text-primary) !important;
        -webkit-box-shadow: 0 0 0px 1000px var(--bg-primary) inset !important;
        box-shadow: 0 0 0px 1000px var(--bg-primary) inset !important;
        transition: background-color 5000s ease-in-out 0s;
        caret-color: var(--text-primary);
    }

    .btn {
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    .btn-primary {
      background-color: var(--accent-primary);
      border-color: var(--accent-primary);
      color: var(--text-primary);
    }
    .btn-primary:hover, .btn-primary:focus {
      background-color: var(--accent-hover);
      border-color: var(--accent-hover);
    }
    .btn-success { 
        background-color: var(--success-primary); 
        border: none; 
        color: white !important; 
    }
    .btn-danger {
        background-color: var(--danger-primary);
        border-color: var(--danger-primary);
    }
    .btn-danger:hover {
        background-color: var(--danger-hover);
        border-color: var(--danger-hover);
    }

    .btn-outline-primary {
        color: var(--accent-primary);
        border-color: var(--accent-primary);
    }
    .btn-outline-primary:hover, .btn-outline-primary.active {
        color: var(--text-primary);
        background-color: var(--accent-primary);
        border-color: var(--accent-primary);
    }

    .table {
        --bs-table-bg: transparent;
        --bs-table-color: var(--text-primary);
        --bs-table-border-color: var(--border-color);
        --bs-table-striped-bg: var(--bg-secondary);
        --bs-table-hover-bg: #374151;
        --bs-table-hover-color: var(--text-primary);
    }
    .table-responsive {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        overflow-x: auto;
    }
    .table th {
        color: var(--text-secondary);
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
    }

    /* --- NEW: Mobile Card Styles --- */
    .mobile-data-card {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        color: var(--text-primary);
    }
    .mobile-data-card .card-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.1rem;
    }
    .mobile-data-card .card-subtitle {
        font-size: 0.85rem;
        color: var(--text-secondary) !important;
        word-break: break-all;
    }


    #course-editor .course-item,
    #grade-editor .grade-item {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        padding: 1rem;
        background-color: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: .5rem;
    }

    .admin-avatar {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 50%;
    }

    .admin-calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
    }
    .admin-calendar-day {
        text-align: center;
        padding: 0.75rem 0.25rem;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.2s ease;
        border: 1px solid transparent;
    }
    .admin-calendar-day:hover {
        background-color: var(--border-color);
        transform: scale(1.05);
    }
    .admin-calendar-day:not(.is-holiday):not(.is-present):not(.is-absent):not(.is-late) {
        background-color: var(--bg-primary);
        border: 1px solid var(--border-color);
    }
    .admin-calendar-day.is-holiday { 
        background-color: #ffc107; 
        color: var(--text-primary); 
        font-weight: bold;
    }
    .admin-calendar-day.is-present { background-color: #16A34A; color: white; }
    .admin-calendar-day.is-absent { background-color: #DC2626; color: white; }
    .admin-calendar-day.is-late { background-color: #2563EB; color: white; }

    main {
      min-width: 0;
    }
  </style>
</head>
<body>

<div id="loader" class="d-flex justify-content-center align-items-center vh-100">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="ms-3 fs-5">Verifying admin access...</p>
</div>

<div id="main-content">
    <nav id="mainNavbar" class="navbar sticky-top d-md-none">
        <div class="container-fluid">
            <button class="btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas">
                <i class="bi bi-list fs-3 text-white"></i>
            </button>
            <span class="navbar-brand mb-0 h1 text-white" id="page-title-mobile">Admin Panel</span>
        </div>
    </nav>
    
    <div class="container-fluid main-container">
        <div class="row flex-grow-1">
            <aside class="col-md-3 col-lg-2 d-none d-md-flex sidebar p-3 flex-column">
                <div>
                    <div class="d-flex align-items-center gap-3 mb-4 px-2">
                        <i class="bi bi-shield-shaded fs-2 text-primary"></i>
                        <h4 class="mb-0">Admin Panel</h4>
                    </div>
                    <h6 class="text-secondary small text-uppercase px-2 mb-2">Collections</h6>
                    <div class="list-group" id="collections-nav-desktop"></div>
                </div>
                <div class="mt-auto">
                    <a href="attendance-taker.html" class="btn btn-dark w-100 text-start mb-2"><i class="bi bi-qr-code-scan me-2"></i>Attendance Scanner</a>
                    <a href="#" class="btn btn-outline-danger w-100" id="logout-btn-desktop"><i class="bi bi-box-arrow-right me-2"></i>Logout</a>
                </div>
            </aside>

            <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas" aria-labelledby="sidebarLabel">
                <div class="offcanvas-header">
                    <div class="d-flex align-items-center gap-3">
                         <i class="bi bi-shield-shaded fs-2 text-primary"></i>
                        <h5 class="offcanvas-title" id="sidebarLabel">Admin Panel</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body d-flex flex-column">
                    <div>
                         <h6 class="text-secondary small text-uppercase px-2 mb-2">Collections</h6>
                        <div class="list-group" id="collections-nav-mobile"></div>
                    </div>
                    <div class="mt-auto">
                        <a href="attendance-taker.html" class="btn btn-dark w-100 text-start mb-2"><i class="bi bi-qr-code-scan me-2"></i>Attendance Scanner</a>
                        <a href="#" class="btn btn-outline-danger w-100" id="logout-btn-mobile"><i class="bi bi-box-arrow-right me-2"></i>Logout</a>
                    </div>
                </div>
            </div>

            <main class="col-md-9 col-lg-10 ms-sm-auto px-md-4 py-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                         <h1 class="h2" id="current-collection-title">Select a Collection</h1>
                         <p class="text-secondary mb-0" id="current-collection-description">Click on a collection from the sidebar to view and manage its documents.</p>
                    </div>
                    <div id="collection-actions"></div>
                </div>
                <div id="filters-container" class="mb-3"></div>
                
                <div id="documents-table-container-desktop" class="d-none d-md-block"></div>
                <div id="documents-list-container-mobile" class="d-md-none vstack gap-3"></div>

            </main>
        </div>
    </div>
</div>

<div class="modal fade" id="editDocModal" tabindex="-1" aria-labelledby="editDocModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editDocModalLabel">Edit Document</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="edit-doc-form-body">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="save-doc-changes">Save changes</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="addNoticeModal" tabindex="-1" aria-labelledby="addNoticeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addNoticeModalLabel">Add New Notice</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="add-notice-form">
            <div class="mb-3">
                <label for="notice-text" class="form-label">Announcement Text</label>
                <textarea class="form-control" id="notice-text" rows="3" required></textarea>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-new-notice">Save Notice</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="addMentorModal" tabindex="-1" aria-labelledby="addMentorModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addMentorModalLabel">Add New Mentor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="add-mentor-form">
            <div class="mb-3">
                <label for="mentor-name" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="mentor-name" required>
            </div>
            <div class="mb-3">
                <label for="mentor-email" class="form-label">Email</label>
                <input type="email" class="form-control" id="mentor-email" required>
            </div>
            <div class="mb-3">
                <label for="mentor-phone" class="form-label">Phone</label>
                <input type="tel" class="form-control" id="mentor-phone" required>
            </div>
            <div class="mb-3">
                <label for="mentor-department" class="form-label">Department</label>
                <select id="mentor-department" class="form-select">
                    <option value="">-- None --</option>
                    <option value="BBA">BBA</option>
                    <option value="BCA">BCA</option>
                    <option value="BHM">BHM</option>
                </select>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-new-mentor">Save Mentor</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this document? This action cannot be undone.</p>
        <p class="text-danger fw-bold" id="delete-doc-id"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="holidayConfirmModal" tabindex="-1" aria-labelledby="holidayConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="holidayConfirmModalLabel">Global Holiday Update</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>You have changed the holiday schedule. This will apply the changes for <strong style="color: var(--accent-primary);">all students</strong> and recalculate their attendance percentages.</p>
        <p>This may take a moment. Do you want to proceed?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirm-holiday-btn">Yes, Apply to All</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="createRoutineModal" tabindex="-1" aria-labelledby="createRoutineModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createRoutineModalLabel">Create New Routine</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="add-routine-form">
            <div class="mb-3">
                <label for="routine-dept-name" class="form-label">Department Name</label>
                <input type="text" class="form-control" id="routine-dept-name" required placeholder="e.g., BBA, BCA (must be exact)">
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-new-routine">Create Routine</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, updateDoc, addDoc, deleteDoc, Timestamp, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDxkvvObHv2IuKMKlp81WVsAtm75gkWB0Y",
        authDomain: "studentportal-eb425.firebaseapp.com",
        projectId: "studentportal-eb425",
        storageBucket: "studentportal-eb425.appspot.com",
        messagingSenderId: "1021027397198",
        appId: "1:1021027397198:web:7195716ef430ebfb359d1f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loader = document.getElementById('loader');
    const mainContent = document.getElementById('main-content');
    const collectionsNavDesktop = document.getElementById('collections-nav-desktop');
    const collectionsNavMobile = document.getElementById('collections-nav-mobile');
    const collectionActions = document.getElementById('collection-actions');
    const currentCollectionTitle = document.getElementById('current-collection-title');
    const currentCollectionDesc = document.getElementById('current-collection-description');
    
    const documentsTableContainerDesktop = document.getElementById('documents-table-container-desktop');
    const documentsListContainerMobile = document.getElementById('documents-list-container-mobile');

    const filtersContainer = document.getElementById('filters-container');
    
    const editDocModalEl = new bootstrap.Modal(document.getElementById('editDocModal'));
    const editDocFormBody = document.getElementById('edit-doc-form-body');
    const saveDocChangesBtn = document.getElementById('save-doc-changes');

    const addNoticeModalEl = new bootstrap.Modal(document.getElementById('addNoticeModal'));
    const saveNewNoticeBtn = document.getElementById('save-new-notice');

    const addMentorModalEl = new bootstrap.Modal(document.getElementById('addMentorModal'));
    const saveNewMentorBtn = document.getElementById('save-new-mentor');

    const confirmDeleteModalEl = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const deleteDocIdEl = document.getElementById('delete-doc-id');

    const holidayConfirmModalEl = new bootstrap.Modal(document.getElementById('holidayConfirmModal'));
    const confirmHolidayBtn = document.getElementById('confirm-holiday-btn');

    const createRoutineModalEl = new bootstrap.Modal(document.getElementById('createRoutineModal'));
    const saveNewRoutineBtn = document.getElementById('save-new-routine');
    
    const logoutBtnDesktop = document.getElementById('logout-btn-desktop');
    const logoutBtnMobile = document.getElementById('logout-btn-mobile');

    let currentEditingDocRef = null;
    let docToDeleteRef = null;
    let currentAttendanceRecords = {};
    let globalHolidayRecords = {};
    let holidaysToAdd = new Set();
    let holidaysToRemove = new Set();

    const gradeToPoints = (grade) => ({'A': 10, 'B': 8, 'C': 6, 'D': 4, 'F': 0}[grade] || 0);

    async function runDailyAbsenceCheck() {
        const today = new Date();
        const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        const checkKey = `absenceCheck_${todayString}`;

        if (sessionStorage.getItem(checkKey)) {
            return;
        }

        const cutoffHour = 10;
        const cutoffMinute = 1;
        if (today.getHours() < cutoffHour || (today.getHours() === cutoffHour && today.getMinutes() < cutoffMinute)) {
            return;
        }

        try {
            const holidayRef = doc(db, "globalData", "holidays");
            const holidaySnap = await getDoc(holidayRef);
            const holidays = holidaySnap.exists() ? holidaySnap.data().dates : {};

            if (holidays[todayString]) {
                sessionStorage.setItem(checkKey, 'true');
                return;
            }

            const attendanceCollectionRef = collection(db, "studentAttendance");
            const attendanceSnapshot = await getDocs(attendanceCollectionRef);
            
            if (attendanceSnapshot.empty) return;

            const batch = writeBatch(db);
            const studentsToUpdate = [];

            attendanceSnapshot.forEach(attendanceDoc => {
                const records = attendanceDoc.data().records || {};
                if (!records.hasOwnProperty(todayString)) {
                    const attendanceDocRef = doc(db, "studentAttendance", attendanceDoc.id);
                    batch.update(attendanceDocRef, { [`records.${todayString}`]: 'absent' });
                    studentsToUpdate.push({
                        id: attendanceDoc.id,
                        records: { ...records, [todayString]: 'absent' }
                    });
                }
            });

            if (studentsToUpdate.length === 0) {
                sessionStorage.setItem(checkKey, 'true');
                return;
            }

            await batch.commit();

            const recalculationBatch = writeBatch(db);
            for (const student of studentsToUpdate) {
                let presentCount = 0;
                let workingDays = 0;
                for (const dateStr in student.records) {
                    if (!holidays[dateStr]) {
                        if (student.records[dateStr] === 'present' || student.records[dateStr] === 'late') presentCount++;
                        if (student.records[dateStr] !== 'holiday') workingDays++;
                    }
                }
                const attendancePercent = workingDays > 0 ? Math.round((presentCount / workingDays) * 100) : 0;
                
                const studentDataRef = doc(db, "studentData", student.id);
                recalculationBatch.update(studentDataRef, { attendance: attendancePercent });
            }
            
            await recalculationBatch.commit();
            sessionStorage.setItem(checkKey, 'true');

            const activeCollectionLink = document.querySelector('.list-group-item-action.active');
            if (activeCollectionLink && activeCollectionLink.textContent.includes('Attendance')) {
                loadDocumentsForCollection(activeCollectionLink.textContent);
            }

        } catch (error) {
            console.error("Error during daily absence check:", error);
        }
    }


    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                const adminRef = doc(db, "admins", user.uid);
                const adminSnap = await getDoc(adminRef);

                if (adminSnap.exists()) {
                    loader.remove();
                    mainContent.style.display = 'flex';
                    await runDailyAbsenceCheck();
                    discoverAndLoadCollections();
                } else {
                    loader.querySelector('p').textContent = 'Access Denied. You do not have admin privileges. Redirecting...';
                    setTimeout(() => { window.location.href = 'login.html'; }, 3000);
                }
            } catch (error) {
                console.error("Admin check error:", error);
                loader.querySelector('p').textContent = `Error verifying access: ${error.message}. Redirecting...`;
                setTimeout(() => { window.location.href = 'login.html'; }, 3000);
            }
        } else {
            loader.querySelector('p').textContent = 'You are not logged in. Redirecting to login...';
            setTimeout(() => { window.location.href = 'adminlogin.html'; }, 2000);
        }
    });

    async function discoverAndLoadCollections() {
        const collectionNames = ['studentData', 'studentCourses', 'studentGrades', 'studentAttendance', 'notices', 'mentors', 'routines']; 
        
        const createNavLinks = (container) => {
            container.innerHTML = '';
            collectionNames.forEach(name => {
                const link = document.createElement('a');
                link.href = '#';
                link.className = 'list-group-item list-group-item-action';
                link.textContent = name;
                link.onclick = (e) => {
                    e.preventDefault();
                    loadDocumentsForCollection(name);
                    document.querySelectorAll('.list-group-item-action').forEach(el => el.classList.remove('active'));
                    document.querySelectorAll(`#collections-nav-desktop a, #collections-nav-mobile a`).forEach(navLink => {
                        if (navLink.textContent === name) navLink.classList.add('active');
                    });
                    const offcanvasInstance = bootstrap.Offcanvas.getInstance(document.getElementById('sidebarOffcanvas'));
                    if (offcanvasInstance) offcanvasInstance.hide();
                };
                container.appendChild(link);
            });
        };
        
        createNavLinks(collectionsNavDesktop);
        createNavLinks(collectionsNavMobile);
    }

    async function loadDocumentsForCollection(collectionName, departmentFilter = 'All') {
        currentCollectionTitle.textContent = `${collectionName}`;
        document.getElementById('page-title-mobile').textContent = `${collectionName}`;
        currentCollectionDesc.textContent = `Viewing all documents in the ${collectionName} collection.`;
        collectionActions.innerHTML = '';
        
        const spinnerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div></div>';
        documentsTableContainerDesktop.innerHTML = `<div class="table-responsive" style="background:transparent; border:none;">${spinnerHTML}</div>`;
        documentsListContainerMobile.innerHTML = spinnerHTML;
        
        filtersContainer.innerHTML = '';

        if (collectionName === 'notices') {
            const addBtn = document.createElement('button');
            addBtn.className = 'btn btn-primary';
            addBtn.innerHTML = '<i class="bi bi-plus-circle me-2"></i>Add Notice';
            addBtn.onclick = () => addNoticeModalEl.show();
            collectionActions.appendChild(addBtn);
        } else if (collectionName === 'mentors') {
            const addBtn = document.createElement('button');
            addBtn.className = 'btn btn-primary';
            addBtn.innerHTML = '<i class="bi bi-person-plus me-2"></i>Add Mentor';
            addBtn.onclick = () => addMentorModalEl.show();
            collectionActions.appendChild(addBtn);
        } else if (collectionName === 'routines') {
            const addBtn = document.createElement('button');
            addBtn.className = 'btn btn-primary';
            addBtn.innerHTML = '<i class="bi bi-calendar-plus me-2"></i>Create Department Routine';
            addBtn.onclick = () => createRoutineModalEl.show();
            collectionActions.appendChild(addBtn);
        }

        if (['studentData', 'mentors', 'studentCourses', 'studentGrades', 'studentAttendance'].includes(collectionName)) {
            const filters = ['All', 'Not Assigned', 'BBA', 'BCA', 'BHM'];
            const filterButtonsHTML = `
                <div class="btn-group" role="group" aria-label="Department Filters">
                    ${filters.map(filter => `
                        <button type="button" 
                                class="btn btn-outline-primary ${filter === departmentFilter ? 'active' : ''}" 
                                data-filter="${filter}">
                            ${filter}
                        </button>
                    `).join('')}
                </div>
            `;
            filtersContainer.innerHTML = filterButtonsHTML;
            
            filtersContainer.querySelector('.btn-group').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const filter = e.target.dataset.filter;
                    loadDocumentsForCollection(collectionName, filter);
                }
            });
        }

        const studentDataMap = new Map();
        const studentDataSnapshot = await getDocs(collection(db, "studentData"));
        studentDataSnapshot.forEach(doc => studentDataMap.set(doc.id, doc.data()));

        const collectionRef = collection(db, collectionName);
        const snapshot = await getDocs(collectionRef);
        let filteredDocs = snapshot.docs;

        if (departmentFilter !== 'All') {
            if (['studentData', 'mentors'].includes(collectionName)) {
                filteredDocs = snapshot.docs.filter(docSnap => {
                    const docData = docSnap.data();
                    if (departmentFilter === 'Not Assigned') return !docData.department;
                    return docData.department === departmentFilter;
                });
            } else if (['studentCourses', 'studentGrades', 'studentAttendance'].includes(collectionName)) {
                filteredDocs = snapshot.docs.filter(docSnap => {
                    const student = studentDataMap.get(docSnap.id);
                    if (departmentFilter === 'Not Assigned') {
                        return !student || !student.department;
                    }
                    return student && student.department === departmentFilter;
                });
            }
        }
        
        if (filteredDocs.length === 0) {
            const noDocsHTML = '<div class="text-center p-4">No documents found matching the current filter.</div>';
            documentsTableContainerDesktop.innerHTML = `<div class="table-responsive">${noDocsHTML}</div>`;
            documentsListContainerMobile.innerHTML = noDocsHTML;
            return;
        }

        documentsTableContainerDesktop.innerHTML = '';
        documentsListContainerMobile.innerHTML = '';

        const table = document.createElement('table');
        table.className = 'table table-hover align-middle';
        const thead = table.createTHead();
        const tbody = table.createTBody();
        let headerRow = thead.insertRow();
        let headers = [];
        if (collectionName === 'studentData') headers = ['Photo', 'Name', 'Email', 'Department', 'SGPA', 'Attendance', 'Actions'];
        else if (collectionName === 'studentCourses') headers = ['Photo', 'Name', 'Email', 'Courses Enrolled', 'Actions'];
        else if (collectionName === 'studentGrades') headers = ['Photo', 'Name', 'Email', 'Courses Graded', 'SGPA', 'Actions'];
        else if (collectionName === 'studentAttendance') headers = ['Photo', 'Name', 'Email', 'Records', 'Actions'];
        else if (collectionName === 'mentors') headers = ['Photo', 'Name', 'Email', 'Phone', 'Department', 'Actions'];
        else if (collectionName === 'routines') headers = ['Department', 'Days Defined', 'Actions'];
        else { const firstDocData = filteredDocs[0]?.data(); headers = ['Document ID', ...(firstDocData ? Object.keys(firstDocData) : []), 'Actions']; }
        headers.forEach(text => headerRow.appendChild(document.createElement('th')).textContent = text);

        for (const docSnap of filteredDocs) {
            const docData = docSnap.data();

            // --- DESKTOP TABLE ROW ---
            const row = tbody.insertRow();
            if (collectionName === 'studentData') {
                const photoCell = row.insertCell();
                const photoImg = document.createElement('img');
                photoImg.src = docData.photoBase64 || 'https://placehold.co/40x40/374151/F9FAFB?text=?';
                photoImg.className = 'admin-avatar';
                photoCell.appendChild(photoImg);
                row.insertCell().textContent = docData.displayName || 'N/A';
                row.insertCell().textContent = docData.email || 'N/A';
                row.insertCell().textContent = docData.department || 'N/A';
                row.insertCell().textContent = docData.sgpa || '0.00';
                row.insertCell().textContent = `${docData.attendance || 0}%`;
            } else if (['studentCourses', 'studentGrades', 'studentAttendance'].includes(collectionName)) {
                const student = studentDataMap.get(docSnap.id);
                const photoCell = row.insertCell();
                const photoImg = document.createElement('img');
                photoImg.className = 'admin-avatar';
                photoCell.appendChild(photoImg);
                const nameCell = row.insertCell();
                const emailCell = row.insertCell();

                if (student) {
                    photoImg.src = student.photoBase64 || 'https://placehold.co/40x40/374151/F9FAFB?text=?';
                    nameCell.textContent = student.displayName || 'N/A';
                    emailCell.textContent = student.email || 'Not Found';
                } else {
                    photoImg.src = 'https://placehold.co/40x40/374151/F9FAFB?text=?';
                    nameCell.textContent = 'Unknown Student';
                    emailCell.textContent = docData.email || docSnap.id;
                }
                
                if (collectionName === 'studentCourses') {
                    row.insertCell().textContent = Array.isArray(docData.list) ? docData.list.length : 0;
                } else if (collectionName === 'studentGrades') {
                    const grades = docData.grades || [];
                    row.insertCell().textContent = grades.length;
                    let totalCredits = 0, totalPoints = 0;
                    grades.forEach(g => {
                        const credits = Number(g.creditHours) || 0;
                        totalCredits += credits;
                        totalPoints += credits * gradeToPoints(g.grade);
                    });
                    const sgpa = totalCredits > 0 ? (totalPoints / totalCredits).toFixed(2) : '0.00';
                    row.insertCell().textContent = sgpa;
                } else if (collectionName === 'studentAttendance') {
                    row.insertCell().textContent = docData.records ? `${Object.keys(docData.records).length} days` : '0 days';
                }
            } else if (collectionName === 'mentors') {
                const photoCell = row.insertCell();
                const photoImg = document.createElement('img');
                photoImg.src = docData.photoBase64 || 'https://placehold.co/40x40/374151/F9FAFB?text=?';
                photoImg.className = 'admin-avatar';
                photoCell.appendChild(photoImg);
                row.insertCell().textContent = docData.name || 'N/A';
                row.insertCell().textContent = docData.email || 'N/A';
                row.insertCell().textContent = docData.phone || 'N/A';
                row.insertCell().textContent = docData.department || 'N/A';
            } else if (collectionName === 'routines') {
                row.insertCell().textContent = docSnap.id;
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                const daysDefined = Object.keys(docData).filter(key => days.includes(key)).length;
                row.insertCell().textContent = `${daysDefined} / 6`;
            } else {
                row.insertCell().textContent = docSnap.id;
                const headerKeys = headers.slice(1, -1);
                headerKeys.forEach(key => {
                    const cell = row.insertCell();
                    const value = docData[key];
                    cell.textContent = (value && typeof value.toDate === 'function') ? value.toDate().toLocaleString() : value;
                });
            }
            const actionCell = row.insertCell();
            const editBtnDesktop = document.createElement('button');
            editBtnDesktop.className = 'btn btn-sm btn-outline-primary me-2 mb-1 mb-lg-0';
            editBtnDesktop.innerHTML = '<i class="bi bi-pencil"></i>';
            editBtnDesktop.onclick = () => openEditModal(docSnap);

            const deleteBtnDesktop = document.createElement('button');
            deleteBtnDesktop.className = 'btn btn-sm btn-outline-danger';
            deleteBtnDesktop.innerHTML = '<i class="bi bi-trash"></i>';
            deleteBtnDesktop.onclick = () => openDeleteModal(docSnap);

            actionCell.appendChild(editBtnDesktop);
            actionCell.appendChild(deleteBtnDesktop);

            // --- MOBILE CARD ---
            const card = document.createElement('div');
            card.className = 'card mobile-data-card';
            const cardBody = document.createElement('div');
            const actionsWrapper = document.createElement('div');
            actionsWrapper.className = 'ms-auto d-flex gap-2';
            
            const editBtnMobile = document.createElement('button');
            editBtnMobile.className = 'btn btn-sm btn-outline-primary';
            editBtnMobile.innerHTML = '<i class="bi bi-pencil"></i>';
            editBtnMobile.onclick = () => openEditModal(docSnap);
            actionsWrapper.appendChild(editBtnMobile);

            const deleteBtnMobile = document.createElement('button');
            deleteBtnMobile.className = 'btn btn-sm btn-outline-danger';
            deleteBtnMobile.innerHTML = '<i class="bi bi-trash"></i>';
            deleteBtnMobile.onclick = () => openDeleteModal(docSnap);
            actionsWrapper.appendChild(deleteBtnMobile);

            if (collectionName === 'notices') {
                cardBody.className = 'card-body d-flex flex-column';
                const postDate = docData.timestamp?.toDate().toLocaleDateString() || 'N/A';
                const author = docData.authorName || 'Admin';
                cardBody.innerHTML = `
                    <p class="mb-2">${docData.text}</p>
                    <small class="text-secondary align-self-end">By ${author} on ${postDate}</small>
                `;
                cardBody.prepend(actionsWrapper);
                actionsWrapper.classList.add('mb-2', 'w-100', 'justify-content-end');

            } else if (collectionName === 'routines') {
                 cardBody.className = 'card-body d-flex align-items-center justify-content-between gap-3';
                 const textWrapper = document.createElement('div');
                 textWrapper.className = 'flex-grow-1';
                 textWrapper.innerHTML = `<h6 class="card-title mb-0">Department: <span class="fw-bold">${docSnap.id}</span></h6>`;
                 cardBody.appendChild(textWrapper);
                 cardBody.appendChild(actionsWrapper);
            } else { // Default mobile card for all other collections
                cardBody.className = 'card-body d-flex align-items-center gap-3';
                const studentInfo = studentDataMap.get(docSnap.id);
                const photoSrc = docData.photoBase64 || (studentInfo && studentInfo.photoBase64) || 'https://placehold.co/40x40/374151/F9FAFB?text=?';
                const name = docData.displayName || docData.name || (studentInfo && studentInfo.displayName) || 'N/A';
                const email = docData.email || (studentInfo && studentInfo.email) || docSnap.id;

                const img = document.createElement('img');
                img.src = photoSrc;
                img.className = 'admin-avatar';
                cardBody.appendChild(img);
                
                const textWrapper = document.createElement('div');
                textWrapper.className = 'flex-grow-1';
                textWrapper.innerHTML = `<h6 class="card-title">${name}</h6><p class="card-subtitle text-muted">${email}</p>`;
                cardBody.appendChild(textWrapper);
                cardBody.appendChild(actionsWrapper);
            }
            
            card.appendChild(cardBody);
            documentsListContainerMobile.appendChild(card);
        }
        
        const tableResponsiveDiv = document.createElement('div');
        tableResponsiveDiv.className = 'table-responsive';
        tableResponsiveDiv.appendChild(table);
        documentsTableContainerDesktop.appendChild(tableResponsiveDiv);
    }
    
    // --- All other functions remain unchanged ---
    
    async function openEditModal(docSnap) {
        currentEditingDocRef = docSnap.ref;
        const data = docSnap.data();
        const collectionName = docSnap.ref.parent.id;
        
        document.getElementById('editDocModalLabel').textContent = `Editing: ${data.email || data.name || docSnap.id}`;
        
        editDocFormBody.innerHTML = '<form id="modalEditForm" autocomplete="off"></form>';
        const formContainer = document.getElementById('modalEditForm');

        if (collectionName === 'studentData') {
            await renderStudentDataEditor(data, formContainer);
        } else if (collectionName === 'studentCourses') {
            renderCourseEditor(data.list || [], formContainer);
        } else if (collectionName === 'studentGrades') {
            renderGradeEditor(data.grades || [], formContainer);
        } else if (collectionName === 'studentAttendance') {
            try {
                const holidayDocRef = doc(db, "globalData", "holidays");
                const holidaySnap = await getDoc(holidayDocRef);
                globalHolidayRecords = holidaySnap.exists() ? holidaySnap.data().dates : {};
            } catch (error) {
                console.warn("Could not load global holidays.", error);
                globalHolidayRecords = {};
            }
            
            currentAttendanceRecords = JSON.parse(JSON.stringify(data.records || {}));
            holidaysToAdd.clear();
            holidaysToRemove.clear();
            renderAttendanceEditor(formContainer);
        } else if (collectionName === 'routines') {
            renderRoutineEditor(data, docSnap.id, formContainer);
        } else {
            renderGenericEditor(data, collectionName, formContainer);
        }
        editDocModalEl.show();
    }

    function renderGenericEditor(data, collectionName, container) {
        container.innerHTML = '';
        for (const key in data) {
            if (key === 'photoBase64' || (collectionName === 'studentData' && key === 'mentorId')) continue;

            const value = data[key];
            const inputId = `edit-${key}`;

            const formGroup = document.createElement('div');
            formGroup.className = 'mb-3';
            
            const label = document.createElement('label');
            label.className = 'form-label';
            label.textContent = key;
            label.setAttribute('for', inputId);
            formGroup.appendChild(label);
            
            let input;
            const isReadOnly = (collectionName === 'studentData' && ['sgpa', 'credits', 'email', 'attendance', 'qrCodeValue'].includes(key)) || (value && typeof value.toDate === 'function');

            if (key === 'department' && (collectionName === 'studentData' || collectionName === 'mentors')) {
                const depts = ['BBA', 'BCA', 'BHM'];
                let optionsHTML = `<option value="" ${!value ? 'selected' : ''}>-- None --</option>` + depts.map(d => `<option value="${d}" ${value === d ? 'selected' : ''}>${d}</option>`).join('');
                input = document.createElement('select');
                input.innerHTML = optionsHTML;
                input.className = 'form-select';
            } else if (typeof value === 'number') {
                input = document.createElement('input');
                input.type = 'number';
                input.className = 'form-control';
            } else if (key === 'text' && typeof value === 'string' && value.length > 100) {
                 input = document.createElement('textarea');
                 input.rows = 4;
                 input.className = 'form-control';
            } else {
                 input = document.createElement('input');
                 input.type = 'text';
                 input.className = 'form-control';
            }
            
            if (isReadOnly) input.disabled = true;
            input.id = inputId;
            input.value = (value && typeof value.toDate === 'function') ? value.toDate().toLocaleString() : value;
            
            formGroup.appendChild(input);
            container.appendChild(formGroup);
        }
    }

    async function renderStudentDataEditor(data, container) {
        renderGenericEditor(data, 'studentData', container);

        const mentorsCol = collection(db, 'mentors');
        const mentorSnapshot = await getDocs(mentorsCol);
        let optionsHTML = '<option value="">-- No Mentor Assigned --</option>';
        mentorSnapshot.forEach(doc => {
            const mentor = doc.data();
            const isSelected = doc.id === data.mentorId ? ' selected' : '';
            optionsHTML += `<option value="${doc.id}"${isSelected}>${mentor.name} (${mentor.department || 'No Dept.'})</option>`;
        });

        const formGroup = document.createElement('div');
        formGroup.className = 'mb-3';
        formGroup.innerHTML = `
            <label class="form-label" for="edit-mentorId">Assigned Mentor</label>
            <select id="edit-mentorId" class="form-select">${optionsHTML}</select>
        `;
        container.appendChild(formGroup);
    }
    
    function renderCourseEditor(courses, container) {
        container.innerHTML = `
            <div id="course-editor">
                <h5 class="mb-3">Enrolled Courses</h5>
                <div id="course-list" class="vstack gap-3"></div>
                <button type="button" class="btn btn-success btn-sm mt-3" id="add-course-btn"><i class="bi bi-plus-circle me-1"></i>Add Course</button>
            </div>
        `;
        const courseList = document.getElementById('course-list');

        const createCourseItem = (course = { name: '', code: '' }) => {
            const item = document.createElement('div');
            item.className = 'course-item';
            item.innerHTML = `
                <div class="flex-grow-1">
                    <input type="text" class="form-control mb-2" data-field="name" placeholder="Course Name" value="${course.name}">
                    <input type="text" class="form-control" data-field="code" placeholder="Course Code" value="${course.code}">
                </div>
                <button type="button" class="btn btn-danger btn-sm remove-item-btn"><i class="bi bi-trash"></i></button>
            `;
            item.querySelector('.remove-item-btn').onclick = () => item.remove();
            return item;
        };

        if (courses.length > 0) {
            courses.forEach(course => courseList.appendChild(createCourseItem(course)));
        } else {
             courseList.appendChild(createCourseItem());
        }

        document.getElementById('add-course-btn').onclick = () => {
            courseList.appendChild(createCourseItem());
        };
    }

    function renderGradeEditor(grades, container) {
        container.innerHTML = `
            <div id="grade-editor">
                <h5 class="mb-3">Course Grades</h5>
                <div id="grade-list" class="vstack gap-3"></div>
                <button type="button" class="btn btn-success btn-sm mt-3" id="add-grade-btn"><i class="bi bi-plus-circle me-1"></i>Add Grade</button>
            </div>
        `;
        const gradeList = document.getElementById('grade-list');
        const gradeOptions = ['A', 'B', 'C', 'D', 'F'].map(g => `<option value="${g}">${g}</option>`).join('');

        const createGradeItem = (grade = { courseName: '', courseCode: '', creditHours: 0, grade: 'A' }) => {
            const item = document.createElement('div');
            item.className = 'grade-item';
            item.innerHTML = `
                <div class="flex-grow-1">
                    <input type="text" class="form-control mb-2" data-field="courseName" placeholder="Course Name" value="${grade.courseName}">
                    <input type="text" class="form-control mb-2" data-field="courseCode" placeholder="Course Code" value="${grade.courseCode}">
                    <div class="input-group">
                        <input type="number" class="form-control" data-field="creditHours" placeholder="Credits" value="${grade.creditHours}">
                        <select class="form-select" data-field="grade"></select>
                    </div>
                </div>
                <button type="button" class="btn btn-danger btn-sm remove-item-btn"><i class="bi bi-trash"></i></button>
            `;
            const selectEl = item.querySelector('[data-field="grade"]');
            selectEl.innerHTML = gradeOptions;
            selectEl.value = grade.grade;

            item.querySelector('.remove-item-btn').onclick = () => item.remove();
            return item;
        };
        
        if(grades.length > 0) {
            grades.forEach(grade => gradeList.appendChild(createGradeItem(grade)));
        } else {
            gradeList.appendChild(createGradeItem());
        }

        document.getElementById('add-grade-btn').onclick = () => {
            gradeList.appendChild(createGradeItem());
        };
    }

    function renderAttendanceEditor(container) {
        let currentDate = new Date();

        const generateAdminCalendar = (year, month) => {
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const dayNames = ["S", "M", "T", "W", "T", "F", "S"];
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            let html = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button id="admin-prev-month" type="button" class="btn btn-outline-secondary">&lt;</button>
                    <h5 class="mb-0">${monthNames[month]} ${year}</h5>
                    <button id="admin-next-month" type="button" class="btn btn-outline-secondary">&gt;</button>
                </div>
                <div class="admin-calendar-grid">
                    ${dayNames.map(d => `<div class="text-center small text-secondary fw-bold">${d}</div>`).join('')}
            `;

            for (let i = 0; i < firstDay.getDay(); i++) { html += `<div></div>`; }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const studentStatus = currentAttendanceRecords[dateString];
                const isGlobalHoliday = globalHolidayRecords[dateString] === true || holidaysToAdd.has(dateString);

                let dayClass = 'admin-calendar-day';
                if (isGlobalHoliday && !holidaysToRemove.has(dateString)) {
                    dayClass += ' is-holiday';
                } else if (studentStatus === 'present') {
                    dayClass += ' is-present';
                } else if (studentStatus === 'absent') {
                    dayClass += ' is-absent';
                } else if (studentStatus === 'late') {
                    dayClass += ' is-late';
                }
                html += `<div class="${dayClass}" data-date="${dateString}">${day}</div>`;
            }
            html += `</div>`;
            container.innerHTML = html;

            document.getElementById('admin-prev-month').onclick = () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                generateAdminCalendar(currentDate.getFullYear(), currentDate.getMonth());
            };
            document.getElementById('admin-next-month').onclick = () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                generateAdminCalendar(currentDate.getFullYear(), currentDate.getMonth());
            };
        };

        generateAdminCalendar(currentDate.getFullYear(), currentDate.getMonth());
        
        container.onclick = (e) => {
            if (e.target.classList.contains('admin-calendar-day')) {
                const dayEl = e.target;
                const date = dayEl.dataset.date;

                const isCurrentlyGlobalHoliday = globalHolidayRecords[date] === true;
                const states = ['present', 'absent', 'late', 'holiday', undefined];
                let currentStatus;

                if ((isCurrentlyGlobalHoliday && !holidaysToRemove.has(date)) || holidaysToAdd.has(date)) {
                    currentStatus = 'holiday';
                } else {
                    currentStatus = currentAttendanceRecords[date];
                }

                const currentIndex = states.indexOf(currentStatus);
                const nextStatus = states[(currentIndex + 1) % states.length];
                
                dayEl.classList.remove('is-present', 'is-absent', 'is-late', 'is-holiday');

                if (nextStatus === 'holiday') {
                    holidaysToAdd.add(date);
                    holidaysToRemove.delete(date);
                    delete currentAttendanceRecords[date];
                } else {
                    if (isCurrentlyGlobalHoliday || holidaysToAdd.has(date)) {
                         holidaysToRemove.add(date);
                    }
                    holidaysToAdd.delete(date);
                    
                    if(nextStatus) {
                        currentAttendanceRecords[date] = nextStatus;
                    } else {
                        delete currentAttendanceRecords[date];
                    }
                }
                
                if (nextStatus === 'present') dayEl.classList.add('is-present');
                else if (nextStatus === 'absent') dayEl.classList.add('is-absent');
                else if (nextStatus === 'late') dayEl.classList.add('is-late');
                else if (nextStatus === 'holiday') dayEl.classList.add('is-holiday');
            }
        };
    }

    function renderRoutineEditor(data, departmentName, container) {
        document.getElementById('editDocModalLabel').textContent = `Editing Routine for: ${departmentName}`;
        container.innerHTML = '<div class="vstack gap-3" id="routine-editor-container"></div>';
        const routineContainer = document.getElementById('routine-editor-container');
        
        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        
        const createPeriodItem = (period = { time: '', subject: '', teacher: '' }) => {
            const item = document.createElement('div');
            item.className = 'period-item input-group input-group-sm mb-2';
            item.innerHTML = `
                <input type="text" class="form-control" data-field="time" placeholder="Time (e.g., 9-10)" value="${period.time}">
                <input type="text" class="form-control" data-field="subject" placeholder="Subject" value="${period.subject}">
                <input type="text" class="form-control" data-field="teacher" placeholder="Teacher" value="${period.teacher}">
                <button type="button" class="btn btn-outline-danger remove-item-btn"><i class="bi bi-trash"></i></button>
            `;
            item.querySelector('.remove-item-btn').onclick = () => item.remove();
            return item;
        };

        days.forEach(day => {
            const dayCard = document.createElement('div');
            dayCard.className = 'card bg-dark';
            dayCard.innerHTML = `
                <div class="card-header fw-bold text-capitalize">${day}</div>
                <div class="card-body">
                    <div class="day-periods-list vstack gap-2" id="routine-editor-${day}"></div>
                    <button type="button" class="btn btn-primary btn-sm mt-2 add-period-btn" data-day="${day}">
                        <i class="bi bi-plus-circle me-1"></i>Add Period
                    </button>
                </div>
            `;
            routineContainer.appendChild(dayCard);
            
            const periodsList = dayCard.querySelector(`#routine-editor-${day}`);
            const periods = data[day] || [];
            if (periods.length > 0) {
                periods.forEach(p => periodsList.appendChild(createPeriodItem(p)));
            }

            dayCard.querySelector('.add-period-btn').onclick = () => {
                periodsList.appendChild(createPeriodItem());
            };
        });
    }

    async function updateGlobalHolidaysAndRecalculateAllAttendance() {
        saveDocChangesBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Updating All Students...';
        saveDocChangesBtn.disabled = true;

        const holidayDocRef = doc(db, "globalData", "holidays");
        const newHolidayData = { ...globalHolidayRecords };
        holidaysToAdd.forEach(date => newHolidayData[date] = true);
        holidaysToRemove.forEach(date => delete newHolidayData[date]);
        
        await setDoc(holidayDocRef, { dates: newHolidayData });

        const studentCollectionRef = collection(db, "studentData");
        const studentSnapshot = await getDocs(studentCollectionRef);
        
        const batch = writeBatch(db);

        for (const studentDoc of studentSnapshot.docs) {
            const studentId = studentDoc.id;
            const attendanceDocRef = doc(db, "studentAttendance", studentId);
            const attendanceSnap = await getDoc(attendanceDocRef);
            
            if (attendanceSnap.exists()) {
                const records = attendanceSnap.data().records || {};
                let presentCount = 0;
                let workingDays = 0;

                for (const dateStr in records) {
                    if (!newHolidayData[dateStr]) {
                        if (records[dateStr] === 'present' || records[dateStr] === 'late') presentCount++;
                        if (records[dateStr] !== 'holiday') workingDays++;
                    }
                }
                const attendancePercent = workingDays > 0 ? Math.round((presentCount / workingDays) * 100) : 0;

                const studentDataRef = doc(db, "studentData", studentId);
                batch.update(studentDataRef, { attendance: attendancePercent });
            }
        }
        await batch.commit();

        saveDocChangesBtn.innerHTML = 'Save changes';
        saveDocChangesBtn.disabled = false;
        return newHolidayData;
    }


    saveDocChangesBtn.onclick = async () => {
        if (holidaysToAdd.size > 0 || holidaysToRemove.size > 0) {
            holidayConfirmModalEl.show();
            return;
        }
        await saveStudentSpecificChanges();
    };

    confirmHolidayBtn.onclick = async () => {
        holidayConfirmModalEl.hide();
        await saveStudentSpecificChanges(true);
    }
    
    async function saveStudentSpecificChanges(processHolidays = false) {
        const collectionName = currentEditingDocRef.parent.id;
        let updatedData = {};
        const form = document.getElementById('modalEditForm');

        let finalHolidayData = globalHolidayRecords;
        if (processHolidays) {
            finalHolidayData = await updateGlobalHolidaysAndRecalculateAllAttendance();
        }

        if (collectionName === 'studentAttendance') {
            updatedData.records = currentAttendanceRecords;
            let presentCount = 0, workingDays = 0;
            for(const dateStr in currentAttendanceRecords) {
                if (!finalHolidayData[dateStr]) {
                    if (currentAttendanceRecords[dateStr] === 'present' || currentAttendanceRecords[dateStr] === 'late') presentCount++;
                    if (currentAttendanceRecords[dateStr] !== 'holiday') workingDays++;
                }
            }
            const attendancePercent = workingDays > 0 ? Math.round((presentCount / workingDays) * 100) : 0;
            await updateDoc(doc(db, "studentData", currentEditingDocRef.id), { attendance: attendancePercent });

        } else if (collectionName === 'studentCourses') {
            const courses = [];
            form.querySelectorAll('#course-editor .course-item').forEach(item => {
                const course = { name: item.querySelector('[data-field="name"]').value, code: item.querySelector('[data-field="code"]').value };
                if (course.name) courses.push(course);
            });
            updatedData.list = courses;
            await updateDoc(doc(db, "studentData", currentEditingDocRef.id), { activeCourses: courses.length });
        
        } else if (collectionName === 'routines') {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            updatedData = {};
            days.forEach(day => {
                const periods = [];
                form.querySelectorAll(`#routine-editor-${day} .period-item`).forEach(item => {
                    const period = {
                        time: item.querySelector('[data-field="time"]').value,
                        subject: item.querySelector('[data-field="subject"]').value,
                        teacher: item.querySelector('[data-field="teacher"]').value,
                    };
                    if (period.time && period.subject) {
                        periods.push(period);
                    }
                });
                updatedData[day] = periods;
            });
        
        } else if (collectionName === 'studentGrades') {
            const grades = [];
            form.querySelectorAll('#grade-editor .grade-item').forEach(item => {
                const grade = {
                    courseName: item.querySelector('[data-field="courseName"]').value,
                    courseCode: item.querySelector('[data-field="courseCode"]').value,
                    creditHours: Number(item.querySelector('[data-field="creditHours"]').value) || 0,
                    grade: item.querySelector('[data-field="grade"]').value,
                };
                if (grade.courseName) grades.push(grade);
            });
            updatedData.grades = grades;
            let totalCredits = 0, totalPoints = 0;
            grades.forEach(g => { totalCredits += g.creditHours; totalPoints += g.creditHours * gradeToPoints(g.grade); });
            const sgpa = totalCredits > 0 ? (totalPoints / totalCredits).toFixed(2) : '0.00';
            await updateDoc(doc(db, "studentData", currentEditingDocRef.id), { sgpa: Number(sgpa), credits: totalCredits });
        } else {
            form.querySelectorAll('.form-control, .form-select, textarea').forEach(input => {
                if (input.disabled) return;
                const key = input.id.replace('edit-', '');
                updatedData[key] = (input.type === 'number') ? Number(input.value) : input.value;
            });
        }

        try {
            await updateDoc(currentEditingDocRef, updatedData);
            editDocModalEl.hide();
            const activeFilterButton = filtersContainer.querySelector('.btn.active');
            const activeFilter = activeFilterButton ? activeFilterButton.dataset.filter : 'All';
            const activeCollection = document.querySelector('.list-group-item-action.active').textContent;
            loadDocumentsForCollection(activeCollection, activeFilter);
        } catch (error) { console.error("Error updating document:", error); }
    }


    saveNewNoticeBtn.onclick = async () => {
        const noticeText = document.getElementById('notice-text').value;
        if (!noticeText.trim()) return;
        try {
            await addDoc(collection(db, 'notices'), { text: noticeText, timestamp: Timestamp.now() });
            addNoticeModalEl.hide();
            document.getElementById('add-notice-form').reset();
            loadDocumentsForCollection('notices');
        } catch(error) { console.error("Error adding notice:", error); }
    };

    saveNewMentorBtn.onclick = async () => {
        const name = document.getElementById('mentor-name').value;
        const email = document.getElementById('mentor-email').value;
        const phone = document.getElementById('mentor-phone').value;
        const department = document.getElementById('mentor-department').value;
        if (!name.trim() || !email.trim()) return;
        try {
            await addDoc(collection(db, 'mentors'), { 
                name, 
                email, 
                phone, 
                department: department || null 
            });
            addMentorModalEl.hide();
            document.getElementById('add-mentor-form').reset();
            loadDocumentsForCollection('mentors');
        } catch(error) { console.error("Error adding mentor:", error); }
    };

    saveNewRoutineBtn.onclick = async () => {
        const deptName = document.getElementById('routine-dept-name').value.trim();
        if (!deptName) return;
        
        try {
            await setDoc(doc(db, "routines", deptName), {
                monday: [],
                tuesday: [],
                wednesday: [],
                thursday: [],
                friday: [],
                saturday: []
            });
            createRoutineModalEl.hide();
            document.getElementById('add-routine-form').reset();
            loadDocumentsForCollection('routines');
        } catch(error) {
            console.error("Error creating routine:", error);
            alert("Error creating routine: " + error.message);
        }
    };

    function openDeleteModal(docSnap) {
        docToDeleteRef = docSnap.ref;
        deleteDocIdEl.textContent = `ID: ${docSnap.id}`;
        confirmDeleteModalEl.show();
    }

    confirmDeleteBtn.onclick = async () => {
        try {
            await deleteDoc(docToDeleteRef);
            confirmDeleteModalEl.hide();
            const activeFilterButton = filtersContainer.querySelector('.btn.active');
            const activeFilter = activeFilterButton ? activeFilterButton.dataset.filter : 'All';
            const activeCollection = document.querySelector('.list-group-item-action.active').textContent;
            loadDocumentsForCollection(activeCollection, activeFilter);
        } catch(error) { console.error("Error deleting document:", error); }
    };
    
    const handleLogout = () => { signOut(auth).then(() => { window.location.href = 'index.html'; }); };
    logoutBtnDesktop.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); });
    logoutBtnMobile.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); });

</script>
<script>
  document.addEventListener('mousemove', (e) => {
    document.documentElement.style.setProperty('--mouse-x', `${e.clientX}px`);
    document.documentElement.style.setProperty('--mouse-y', `${e.clientY}px`);
  });
</script>
</body>
</html>