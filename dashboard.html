<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard - Student Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --background-dark: #0D1117;
      --panel-glass-bg: rgba(22, 27, 34, 0.8); 
      --text-primary: #f0f6fc; 
      --text-secondary: #dee2e6; 
      --accent-start: #A855F7;
      --accent-end: #D946EF;
      --border-glow: rgba(168, 85, 247, 0.5);
      --border-color: rgba(255, 255, 255, 0.1);
      --mouse-x: 50%;
      --mouse-y: 50%;
    }
    body { 
      font-family: 'Inter', system-ui, sans-serif;
      color: var(--text-primary);
      background: 
        radial-gradient(circle at top left, rgba(168, 85, 247, 0.15) 0%, transparent 40%),
        radial-gradient(circle at bottom right, rgba(217, 70, 239, 0.12) 0%, transparent 50%),
        var(--background-dark);
      background-attachment: fixed;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }
    body::after {
        content: '';
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: radial-gradient(600px circle at var(--mouse-x) var(--mouse-y), rgba(168, 85, 247, 0.1), transparent 80%);
        z-index: -1;
        pointer-events: none;
    }
    .main-container {
        display: flex;
        flex-grow: 1;
    }
    .main-container > .row {
        flex-grow: 1;
    }
    .sidebar, .offcanvas {
      background: var(--panel-glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: var(--text-primary);
      border-right: 1px solid var(--border-color);
    }
    .sidebar a {
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: .5rem;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .sidebar a.active, .sidebar a:hover {
      background: rgba(168, 85, 247, 0.15);
      color: #fff;
    }
    #mainNavbar {
      background: var(--panel-glass-bg) !important;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    #page-title, #user-name, h1, h2, h3, h4, h5, h6, .card-text {
        color: var(--text-primary) !important;
    }
    .card {
      background: var(--panel-glass-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 30px rgba(0,0,0,.4), 0 0 15px var(--border-glow);
    }
    .text-muted, .text-secondary {
        color: var(--text-secondary) !important;
    }
    .form-label {
      color: var(--text-primary) !important;
    }
    .form-control {
      background-color: rgba(0,0,0,0.2);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    .form-control:focus {
      background-color: rgba(0,0,0,0.2);
      border-color: var(--accent-start);
      color: var(--text-primary);
      box-shadow: 0 0 0 0.25rem rgba(168, 85, 247, 0.25);
    }
    .form-control:disabled {
        background-color: rgba(0,0,0,0.2);
        opacity: 0.7;
    }
    .btn-primary {
      border-radius: 8px;
      font-weight: 600;
      border: 2px solid var(--accent-start);
      background: transparent;
      color: var(--accent-start);
      transition: all 0.3s ease;
    }
    .btn-primary:hover, .btn-primary:focus {
      background: linear-gradient(90deg, var(--accent-start), var(--accent-end));
      color: #fff;
      border-color: transparent;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(168, 85, 247, 0.3);
    }
    .avatar {
      width: 40px; height: 40px; object-fit: cover; border-radius: 50%;
      border: 2px solid var(--border-color);
    }
    .profile-avatar, .mentor-avatar {
        width: 120px; height: 120px;
        object-fit: cover; border-radius: 50%;
        border: 4px solid var(--accent-start);
        box-shadow: 0 4px 12px rgba(0,0,0,.1);
    }
    .offcanvas-start { width: 280px; }
    
    .table {
        --bs-table-bg: transparent;
        --bs-table-color: var(--text-primary);
        --bs-table-border-color: var(--border-color);
        --bs-table-striped-bg: rgba(168, 85, 247, 0.05);
        --bs-table-hover-bg: rgba(168, 85, 247, 0.1);
        --bs-table-hover-color: var(--text-primary);
    }
    .grade-badge {
        display: inline-block;
        width: 32px;
        height: 32px;
        line-height: 32px;
        text-align: center;
        border-radius: 50%;
        font-weight: 600;
    }
    .grade-a { background-color: #28a745; color: white; }
    .grade-b { background-color: #17a2b8; color: white; }
    .grade-c { background-color: #ffc107; color: black; }
    .grade-d { background-color: #fd7e14; color: white; }
    .grade-f { background-color: #dc3545; color: white; }
    
    #qrcode {
        padding: 10px;
        background: white;
        border-radius: 8px;
    }
     #qrcode img {
        display: block;
        margin: auto;
    }
    
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
    }
    .calendar-day, .calendar-day-name {
        text-align: center;
        padding: 0.75rem 0.25rem;
        border-radius: 8px;
    }
    .calendar-day {
        color: white;
    }
    .calendar-day-name {
        font-weight: 600;
        color: var(--text-secondary);
    }
    .calendar-day.is-present { background-color: rgba(40, 167, 69, 0.7); color: white; }
    .calendar-day.is-absent { background-color: rgba(220, 53, 69, 0.7); color: white; }
    .calendar-day.is-holiday { background-color: rgba(255, 193, 7, 0.7); color: black; }
    /* --- NEW: Style for late days --- */
    .calendar-day.is-late { background-color: rgba(13, 110, 253, 0.7); color: white; }
    .calendar-day.is-today {
        box-shadow: 0 0 0 2px var(--accent-start);
    }
    .legend {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 1.5rem;
        margin-top: 1.5rem;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #page-content .card, #page-content .row > [class*="col-"], #page-content .table-responsive {
      opacity: 0;
      animation: fadeInUp 0.6s ease-out forwards;
    }
    #page-content .row > [class*="col-"]:nth-child(1) { animation-delay: 0.1s; }
    #page-content .row > [class*="col-"]:nth-child(2) { animation-delay: 0.2s; }
    #page-content .row > [class*="col-"]:nth-child(3) { animation-delay: 0.3s; }
    #page-content .row > [class*="col-"]:nth-child(4) { animation-delay: 0.4s; }
    #page-content .table-responsive { animation-delay: 0.3s; }

    @keyframes jiggle {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-5deg); }
      75% { transform: rotate(5deg); }
    }
    #page-content .card .bi {
      transition: transform 0.3s ease;
    }
    #page-content .card:hover .bi {
      animation: jiggle 0.4s ease;
    }
    .truncate-text {
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow-wrap: break-word;
        word-wrap: break-word;
        min-width: 0; 
    }
  </style>
</head>
<body>
  
  <nav id="mainNavbar" class="navbar navbar-expand-md sticky-top">
    <div class="container-fluid">
      <button class="btn d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas" aria-label="Toggle navigation">
        <i class="bi bi-list fs-3 text-white"></i>
      </button>
      <span class="navbar-brand mb-0 h1" id="page-title">Dashboard</span>
      <div class="d-flex align-items-center gap-2">
        <a href="#/profile" class="text-decoration-none d-flex align-items-center gap-2">
          <img src="https://placehold.co/40x40/EFEFEF/333333?text=?" alt="Profile" class="avatar" id="user-avatar">
          <span class="fw-semibold d-none d-sm-inline" id="user-name">Loading...</span>
        </a>
      </div>
    </div>
  </nav>

  <div class="container-fluid main-container">
    <div class="row">
      <aside class="col-md-3 col-lg-2 d-none d-md-block sidebar px-3">
        <div class="py-4 d-flex align-items-center gap-2">
          <img src="https://img.icons8.com/ios-filled/50/ffffff/student-male.png" alt="Logo" style="width: 40px;">
          <h5 class="mb-0">Student Portal</h5>
        </div>
        <nav class="nav flex-column gap-1 pb-4" id="desktop-nav">
          <a class="nav-link px-3 py-2 active" href="#/dashboard"><i class="bi bi-house-door me-2"></i>Dashboard</a>
          <a class="nav-link px-3 py-2" href="#/courses"><i class="bi bi-book me-2"></i>Courses</a>
          <a class="nav-link px-3 py-2" href="#/assignments"><i class="bi bi-journal-text me-2"></i>Assignments</a>
          <a class="nav-link px-3 py-2" href="#/grades"><i class="bi bi-bar-chart-line me-2"></i>Grades</a>
          <a class="nav-link px-3 py-2" href="#/attendance"><i class="bi bi-calendar-check me-2"></i>Attendance</a>
          <a class="nav-link px-3 py-2" href="#/announcements"><i class="bi bi-megaphone me-2"></i>Announcements</a>
          <a class="nav-link px-3 py-2" href="#/profile"><i class="bi bi-person-circle me-2"></i>Profile</a>
          <a class="nav-link px-3 py-2" href="#/contact"><i class="bi bi-person-rolodex me-2"></i>Contact Us</a>
          <a class="nav-link px-3 py-2" href="#" id="logout-btn"><i class="bi bi-box-arrow-right me-2"></i>Logout</a>
        </nav>
      </aside>

      <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas" aria-labelledby="sidebarLabel">
        <div class="offcanvas-header">
          <div class="d-flex align-items-center gap-2">
            <img src="https://img.icons8.com/ios-filled/50/ffffff/student-male.png" alt="Logo" style="width: 40px;">
            <h5 class="offcanvas-title" id="sidebarLabel">Student Portal</h5>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body sidebar pt-0">
          <nav class="nav flex-column gap-1" id="mobile-nav">
            <a class="nav-link px-3 py-2 active" href="#/dashboard"><i class="bi bi-house-door me-2"></i>Dashboard</a>
            <a class="nav-link px-3 py-2" href="#/courses"><i class="bi bi-book me-2"></i>Courses</a>
            <a class="nav-link px-3 py-2" href="#/assignments"><i class="bi bi-journal-text me-2"></i>Assignments</a>
            <a class="nav-link px-3 py-2" href="#/grades"><i class="bi bi-bar-chart-line me-2"></i>Grades</a>
            <a class="nav-link px-3 py-2" href="#/attendance"><i class="bi bi-calendar-check me-2"></i>Attendance</a>
            <a class="nav-link px-3 py-2" href="#/announcements"><i class="bi bi-megaphone me-2"></i>Announcements</a>
            <a class="nav-link px-3 py-2" href="#/profile"><i class="bi bi-person-circle me-2"></i>Profile</a>
            <a class="nav-link px-3 py-2" href="#/contact"><i class="bi bi-person-rolodex me-2"></i>Contact Us</a>
            <a class="nav-link px-3 py-2" href="#" id="logout-btn-mobile"><i class="bi bi-box-arrow-right me-2"></i>Logout</a>
          </nav>
        </div>
      </div>

      <main class="col-md-9 col-lg-10 ms-sm-auto px-3 px-md-4 py-4" id="page-content">
          </main>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, query, orderBy, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDxkvvObHv2IuKMKlp81WVsAtm75gkWB0Y",
        authDomain: "studentportal-eb425.firebaseapp.com",
        projectId: "studentportal-eb425",
        storageBucket: "studentportal-eb425.appspot.com",
        messagingSenderId: "1021027397198",
        appId: "1:1021027397198:web:7195716ef430ebfb359d1f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const pageContent = document.getElementById('page-content');
    const pageTitle = document.getElementById('page-title');
    let currentUser = null;
    
    const loaderHTML = `
        <div class="d-flex justify-content-center align-items-center" style="height: 60vh;">
            <div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--accent-start);" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>`;
    
    
    const gradeToPoints = (grade) => ({'A': 10, 'B': 8, 'C': 6, 'D': 4, 'F': 0}[grade] || 0);

    const mobileNavLinks = document.querySelectorAll('#mobile-nav a');
    const sidebarOffcanvasEl = document.getElementById('sidebarOffcanvas');
    const sidebar = new bootstrap.Offcanvas(sidebarOffcanvasEl);
    mobileNavLinks.forEach(link => {
        link.addEventListener('click', () => {
            sidebar.hide();
        });
    });

    const renderDashboard = async (user) => {
        const studentDataRef = doc(db, "studentData", user.uid);
        let studentSnap = await getDoc(studentDataRef);
        const studentData = studentSnap.data();

        pageContent.innerHTML = `
            <div class="row g-4">
              <div class="col-md-7"><div class="card h-100"><div class="card-body p-4">
                    <h5 class="card-title mb-2">Welcome Back, ${studentData.displayName || user.email.split('@')[0]}!</h5>
                    <p class="card-text mb-0 text-muted">You are enrolled in <strong>${studentData.activeCourses}</strong> active courses.</p>
              </div></div></div>
              <div class="col-md-5"><div class="card h-100"><div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                      <h5 class="card-title mb-0">Upcoming Assignments</h5><i class="bi bi-calendar2-week fs-4 text-secondary"></i>
                    </div>
                    <p class="mt-2 mb-3 text-muted"><strong>${studentData.assignmentsDue}</strong> assignments are due this week.</p>
                    <a href="#/assignments" class="btn btn-primary">View Assignments</a>
              </div></div></div>
            </div>
            <div class="row g-4 mt-1">
              <div class="col-6 col-lg-3"><div class="card h-100"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><span class="text-muted">Credits</span><i class="bi bi-mortarboard fs-4 text-secondary"></i></div><h4 class="mt-2 mb-0">${studentData.credits}</h4></div></div></div>
              <div class="col-6 col-lg-3"><div class="card h-100"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><span class="text-muted">Attendance</span><i class="bi bi-clipboard-check fs-4 text-secondary"></i></div><h4 class="mt-2 mb-0">${studentData.attendance}%</h4></div></div></div>
              <div class="col-6 col-lg-3"><div class="card h-100"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><span class="text-muted">SGPA</span><i class="bi bi-graph-up-arrow fs-4 text-secondary"></i></div><h4 class="mt-2 mb-0">${studentData.sgpa}</h4></div></div></div>
              <div class="col-6 col-lg-3"><div class="card h-100"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><span class="text-muted">Messages</span><i class="bi bi-envelope fs-4 text-secondary"></i></div><h4 class="mt-2 mb-0">${studentData.messages}</h4></div></div></div>
            </div>`;
    };
    
    const renderAttendance = async (user) => {
        const attendanceRef = doc(db, "studentAttendance", user.uid);
        const holidayRef = doc(db, "globalData", "holidays");

        let attendanceData = {};
        let holidayData = {};

        try {
            const attendanceSnap = await getDoc(attendanceRef);
            if (attendanceSnap.exists()) {
                attendanceData = attendanceSnap.data().records || {};
            }
            const holidaySnap = await getDoc(holidayRef);
            if (holidaySnap.exists()) {
                holidayData = holidaySnap.data().dates || {};
            }
        } catch (error) {
            console.error("Error fetching attendance data:", error);
        }

        pageContent.innerHTML = `
            <h1 class="mb-4">My Attendance</h1>
            <div id="monthly-stats-container" class="mb-4"></div>
            <div class="card">
                <div class="card-body p-lg-4" id="calendar-container">
                    </div>
            </div>`;

        let currentDate = new Date();

        const generateCalendar = (year, month) => {
            const container = document.getElementById('calendar-container');
            if (!container) return;

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayIndex = firstDay.getDay();

            let monthPresent = 0;
            let monthWorkingDays = 0;
            const today = new Date();
            today.setHours(0,0,0,0);

            for (let day = 1; day <= daysInMonth; day++) {
                const loopDate = new Date(year, month, day);
                 if (loopDate > today) break;

                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                if (holidayData[dateString]) continue;

                const status = attendanceData[dateString];
                if (status === 'present' || status === 'absent' || status === 'late') {
                    monthWorkingDays++;
                    if (status === 'present' || status === 'late') {
                        monthPresent++;
                    }
                }
            }
            
            const monthlyPercentage = monthWorkingDays > 0 ? Math.round((monthPresent / monthWorkingDays) * 100) : 'N/A';
            const statsContainer = document.getElementById('monthly-stats-container');
            statsContainer.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title text-center mb-0">Attendance for ${monthNames[month]} ${year}: <span class="fw-bold" style="color: var(--accent-start);">${monthlyPercentage}${monthlyPercentage !== 'N/A' ? '%' : ''}</span></h5>
                    </div>
                </div>`;


            let calendarHTML = `
                <div class="calendar-header">
                    <button id="prev-month" class="btn btn-outline-light">&lt;</button>
                    <h4 class="mb-0">${monthNames[month]} ${year}</h4>
                    <button id="next-month" class="btn btn-outline-light">&gt;</button>
                </div>
                <div class="calendar-grid">
                    ${dayNames.map(day => `<div class="calendar-day-name">${day}</div>`).join('')}
            `;

            for (let i = 0; i < startDayIndex; i++) {
                calendarHTML += `<div></div>`;
            }


            for (let day = 1; day <= daysInMonth; day++) {
                const loopDate = new Date(year, month, day);
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const status = attendanceData[dateString];
                let dayClass = 'calendar-day';

                if (holidayData[dateString]) {
                    dayClass += ' is-holiday';
                } else if (status === 'present') {
                    dayClass += ' is-present';
                } else if (status === 'absent') {
                    dayClass += ' is-absent';
                } else if (status === 'late') { // --- MODIFIED: Check for late status ---
                    dayClass += ' is-late';
                }
                
                if (loopDate.getTime() === today.getTime()) {
                    dayClass += ' is-today';
                }

                calendarHTML += `<div class="${dayClass}">${day}</div>`;
            }

            // --- MODIFIED: Added Late to legend ---
            calendarHTML += `</div>
                <div class="legend">
                    <div class="legend-item"><span class="legend-color" style="background-color: rgba(40, 167, 69, 0.7);"></span> Present</div>
                    <div class="legend-item"><span class="legend-color" style="background-color: rgba(220, 53, 69, 0.7);"></span> Absent</div>
                    <div class="legend-item"><span class="legend-color" style="background-color: rgba(13, 110, 253, 0.7);"></span> Late</div>
                    <div class="legend-item"><span class="legend-color" style="background-color: rgba(255, 193, 7, 0.7);"></span> Holiday</div>
                </div>
            `;
            container.innerHTML = calendarHTML;

            document.getElementById('prev-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
            });
            document.getElementById('next-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
            });
        };
        
        generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
    };

    const renderAnnouncements = async () => {
        const q = query(collection(db, "notices"), orderBy("timestamp", "desc"));
        const querySnapshot = await getDocs(q);
        
        let announcementsHTML = '';
        if (querySnapshot.empty) {
            announcementsHTML = '<div class="alert alert-info">No announcements posted.</div>';
        } else {
            announcementsHTML = querySnapshot.docs.map(doc => {
                const notice = doc.data();
                const postDate = notice.timestamp.toDate();
                return `<div class="card">
                            <div class="card-body">
                                <p class="card-text fs-5">${notice.text}</p>
                                <small class="text-muted">Posted on ${postDate.toLocaleDateString()} at ${postDate.toLocaleTimeString()}</small>
                            </div>
                        </div>`;
            }).join('');
        }

        pageContent.innerHTML = `<div class="row"><div class="col-md-10 offset-md-1 col-lg-8 offset-lg-2">
            <h1 class="mb-4">Latest Updates</h1>
            <div id="announcements-container" class="vstack gap-3">${announcementsHTML}</div>
            </div></div>`;
    };

    const renderProfile = async (user) => {
        const studentDocRef = doc(db, "studentData", user.uid);
        const studentSnap = await getDoc(studentDocRef);
        const studentData = studentSnap.data();
        const photo = studentData?.photoBase64 || 'https://placehold.co/120x120/EFEFEF/333333?text=?';

        pageContent.innerHTML = `
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-body p-4">
                            <div class="row">
                                <div class="col-md-8">
                                    <h2 class="mb-4">Edit Profile</h2>
                                    <form id="profile-form">
                                        <div class="mb-3">
                                            <label for="displayName" class="form-label">Display Name</label>
                                            <input type="text" class="form-control" id="displayName" value="${studentData.displayName || ''}" placeholder="Enter your full name">
                                        </div>
                                        <div class="mb-3">
                                            <label for="email" class="form-label">Email Address</label>
                                            <input type="email" class="form-control" id="email" value="${user.email}" disabled>
                                        </div>
                                        <div class="mb-3">
                                            <label for="photoUpload" class="form-label">Change Profile Picture</label>
                                            <input class="form-control" type="file" id="photoUpload" accept="image/png, image/jpeg">
                                        </div>
                                        <div id="alert-container"></div>
                                        <button type="submit" class="btn btn-primary w-100" id="save-profile-btn">
                                            Save Changes
                                        </button>
                                    </form>
                                </div>
                                <div class="col-md-4 text-center mt-4 mt-md-0">
                                    <h5 class="mb-3">Your QR Code</h5>
                                    <div id="qrcode" class="mx-auto" style="width: 180px; height: 180px;"></div>
                                    <small class="text-muted d-block mt-2">Show this for attendance</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        
        new QRCode(document.getElementById("qrcode"), {
            text: user.uid,
            width: 160,
            height: 160,
            colorDark : "#0D1117",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });

        const profileForm = document.getElementById('profile-form');
        const displayNameInput = document.getElementById('displayName');
        const photoUploadInput = document.getElementById('photoUpload');
        const saveBtn = document.getElementById('save-profile-btn');
        const alertContainer = document.getElementById('alert-container');
        let newPhotoBase64 = null;

        photoUploadInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 400, MAX_HEIGHT = 400;
                        let { width, height } = img;
                        if (width > height) {
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        } else {
                            if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                        }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        newPhotoBase64 = canvas.toDataURL('image/jpeg', 0.9);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
            alertContainer.innerHTML = '';
            try {
                await updateProfile(auth.currentUser, { displayName: displayNameInput.value });
                const studentDataRef = doc(db, "studentData", user.uid);
                const updates = { displayName: displayNameInput.value };
                if (newPhotoBase64) {
                    updates.photoBase64 = newPhotoBase64;
                    document.getElementById('user-avatar').src = newPhotoBase64;
                }
                await setDoc(studentDataRef, updates, { merge: true });

                document.getElementById('user-name').textContent = displayNameInput.value;
                alertContainer.innerHTML = '<div class="alert alert-success" style="background-color: rgba(168, 85, 247, 0.1); border-color: var(--accent-start); color: var(--text-primary);">Profile updated successfully!</div>';

            } catch (error) {
                console.error("Profile Update Error: ", error);
                alertContainer.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'Save Changes';
            }
        });
    };
    
    const renderCourses = async (user) => {
        const studentCoursesRef = doc(db, "studentCourses", user.uid);
        const docSnap = await getDoc(studentCoursesRef);
        
        let coursesHTML = '';
        if (!docSnap.exists() || !docSnap.data().list || docSnap.data().list.length === 0) {
            coursesHTML = '<div class="col-12"><div class="alert alert-info">You are not enrolled in any courses.</div></div>';
        } else {
            const courses = docSnap.data().list;
            coursesHTML = courses.map(course => `
                <div class="col-12 col-lg-6 col-xl-4">
                    <div class="card h-100">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${course.name}</h5>
                            <p class="card-subtitle mb-2 text-muted">${course.code}</p>
                            <a href="#" class="btn btn-primary mt-auto">Go to Course</a>
                        </div>
                    </div>
                </div>`).join('');
        }
        
        pageContent.innerHTML = `
            <h1 class="mb-4">My Courses</h1>
            <div id="courses-container" class="row g-4">${coursesHTML}</div>`;
    };

    const renderGrades = async (user) => {
        const gradesRef = doc(db, "studentGrades", user.uid);
        const gradesSnap = await getDoc(gradesRef);

        if (!gradesSnap.exists() || !gradesSnap.data().grades || gradesSnap.data().grades.length === 0) {
            pageContent.innerHTML = `
                <h1 class="mb-4">My Grades</h1>
                <div class="alert mt-3" style="background-color: rgba(168, 85, 247, 0.1); border-color: var(--accent-start); color: var(--text-primary);">
                    No grades have been posted yet. Check back later!
                </div>`;
            return;
        }

        const grades = gradesSnap.data().grades;
        let totalCredits = 0;
        let totalPoints = 0;

        grades.forEach(g => {
            totalCredits += g.creditHours;
            totalPoints += g.creditHours * gradeToPoints(g.grade);
        });

        const overallSgpa = totalCredits > 0 ? (totalPoints / totalCredits).toFixed(2) : '0.00';

        const tableRows = grades.map(g => `
            <tr>
                <td>${g.courseName}</td>
                <td>${g.courseCode}</td>
                <td>${g.creditHours}</td>
                <td><span class="grade-badge grade-${g.grade.toLowerCase()}">${g.grade}</span></td>
            </tr>
        `).join('');

        pageContent.innerHTML = `
            <h1 class="mb-4">My Grades</h1>
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body d-flex justify-content-between align-items-center p-4">
                            <div>
                                <h6 class="card-subtitle text-muted">Overall SGPA</h6>
                                <h2 class="card-title mb-0">${overallSgpa}</h2>
                            </div>
                            <i class="bi bi-graph-up-arrow fs-1 text-secondary"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body d-flex justify-content-between align-items-center p-4">
                            <div>
                                <h6 class="card-subtitle text-muted">Total Credits Earned</h6>
                                <h2 class="card-title mb-0">${totalCredits}</h2>
                            </div>
                            <i class="bi bi-mortarboard fs-1 text-secondary"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th scope="col">Course Name</th>
                            <th scope="col">Course Code</th>
                            <th scope="col">Credits</th>
                            <th scope="col">Grade</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            </div>
        `;
    };
    
    const renderContact = async (user) => {
        const studentDocRef = doc(db, "studentData", user.uid);
        const studentSnap = await getDoc(studentDocRef);

        if (!studentSnap.exists() || !studentSnap.data().mentorId) {
            pageContent.innerHTML = `
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card text-center p-4">
                            <i class="bi bi-person-exclamation fs-1 text-secondary mb-3"></i>
                            <h2 class="card-title">Mentor Not Assigned</h2>
                            <p class="card-text text-muted">Your mentor has not been assigned yet. Please check back later or contact the administration.</p>
                        </div>
                    </div>
                </div>`;
            return;
        }

        const mentorId = studentSnap.data().mentorId;
        const mentorRef = doc(db, "mentors", mentorId);
        const mentorSnap = await getDoc(mentorRef);

        if (!mentorSnap.exists()) {
             pageContent.innerHTML = `
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card text-center p-4">
                             <i class="bi bi-patch-question fs-1 text-secondary mb-3"></i>
                             <h2 class="card-title">Error Finding Mentor</h2>
                             <p class="card-text text-muted">We couldn't find the details for your assigned mentor. Please contact the administration for assistance.</p>
                        </div>
                    </div>
                </div>`;
            return;
        }

        const mentor = mentorSnap.data();
        const photo = mentor.photoBase64 || 'https://placehold.co/120x120/EFEFEF/333333?text=?';

        pageContent.innerHTML = `
             <div class="row justify-content-center">
                <div class="col-lg-8">
                    <h1 class="mb-4">Your Mentor</h1>
                    <div class="card">
                        <div class="card-body p-4 text-center">
                            <img src="${photo}" alt="Mentor Picture" class="mentor-avatar mb-3">
                            <h2 class="card-title">${mentor.name}</h2>
                            <hr style="border-color: var(--border-color);">
                            <div class="text-start mt-4">
                                <p class="fs-5"><i class="bi bi-envelope-at me-3"></i><a href="mailto:${mentor.email}" class="text-decoration-none" style="color: var(--text-primary);">${mentor.email}</a></p>
                                <p class="fs-5"><i class="bi bi-telephone me-3"></i><a href="tel:${mentor.phone}" class="text-decoration-none" style="color: var(--text-primary);">${mentor.phone}</a></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    };

    const renderComingSoon = (pageName) => {
        pageContent.innerHTML = `<div class="text-center py-5">
            <i class="bi bi-cone-striped fs-1 text-warning"></i><h1 class="mt-3">${pageName}</h1>
            <p class="lead text-muted">This page is under construction. Check back soon!</p></div>`;
    };

    const routes = {
        '/dashboard': { title: 'Dashboard', render: renderDashboard },
        '/courses': { title: 'Courses', render: renderCourses },
        '/announcements': { title: 'Announcements', render: renderAnnouncements },
        '/profile': { title: 'Profile', render: renderProfile },
        '/grades': { title: 'Grades', render: renderGrades },
        '/attendance': { title: 'Attendance', render: renderAttendance },
        '/contact': { title: 'Contact Us', render: renderContact },
        '/assignments': { title: 'Assignments', render: () => renderComingSoon('Assignments') },
    };

    const router = async () => {
        const path = window.location.hash.substring(1) || '/dashboard';
        const route = routes[path] || routes['/dashboard'];
        
        pageTitle.textContent = route.title;
        pageContent.innerHTML = loaderHTML;
        
        if(currentUser) await route.render(currentUser);

        document.querySelectorAll('#desktop-nav a, #mobile-nav a').forEach(a => {
            a.classList.remove('active');
            if (a.getAttribute('href') === `#${path}`) { a.classList.add('active'); }
        });
    };

    window.addEventListener('hashchange', router);
    window.addEventListener('load', () => { if (!window.location.hash) { window.location.hash = '#/dashboard'; } });

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            
            const studentDataRef = doc(db, "studentData", user.uid);
            let studentSnap = await getDoc(studentDataRef);
            if (!studentSnap.exists() || !studentSnap.data().qrCodeValue) {
                 await setDoc(studentDataRef, { 
                    email: user.email, 
                    displayName: user.displayName || user.email.split('@')[0],
                    qrCodeValue: user.uid,
                    activeCourses: 0, 
                    assignmentsDue: 0, 
                    credits: 0, 
                    attendance: 0, 
                    sgpa: 0.0, 
                    messages: 0,
                    mentorId: null
                }, { merge: true });
            }
            
            const studentCoursesRef = doc(db, "studentCourses", user.uid);
            let coursesSnap = await getDoc(studentCoursesRef);
            if (!coursesSnap.exists()) {
                await setDoc(studentCoursesRef, { email: user.email, list: [] });
            }
            const studentGradesRef = doc(db, "studentGrades", user.uid);
            let gradesSnap = await getDoc(studentGradesRef);
            if (!gradesSnap.exists()) {
                await setDoc(studentGradesRef, { email: user.email, grades: [] });
            }
            const studentAttendanceRef = doc(db, "studentAttendance", user.uid);
            let attendanceSnap = await getDoc(studentAttendanceRef);
            if (!attendanceSnap.exists()) {
                await setDoc(studentAttendanceRef, { email: user.email, records: {} });
            }

            const freshStudentSnap = await getDoc(studentDataRef);
            const studentData = freshStudentSnap.data();
            document.getElementById('user-name').textContent = studentData.displayName || user.email.split('@')[0];
            if (studentData && studentData.photoBase64) {
                document.getElementById('user-avatar').src = studentData.photoBase64;
            }

            router();
        } else { window.location.href = 'login.html'; }
    });

    const handleLogout = () => { signOut(auth).then(() => { window.location.href = 'index.html'; }); };
    document.getElementById('logout-btn').addEventListener('click', handleLogout);
    document.getElementById('logout-btn-mobile').addEventListener('click', handleLogout);
  </script>

  <script>
    document.addEventListener('mousemove', (e) => {
      document.documentElement.style.setProperty('--mouse-x', `${e.clientX}px`);
      document.documentElement.style.setProperty('--mouse-y', `${e.clientY}px`);
    });
  </script>
</body>
</html>