<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Admin Login</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
        <style>
            
            body {
                background: url('https://images.unsplash.com/photo-1481627834876-b7833e8f5570?q=80&w=2756&auto=format&fit=crop') no-repeat center center fixed;
                background-size: cover;
                animation: zoomPan 25s infinite alternate linear;
            }

            .vh-100 {
                background: rgba(0, 0, 0, 0.4);
                backdrop-filter: blur(5px);
            }

            .h-custom {
            height: calc(100% - 73px);
            }
            .img-fluid{
                display: none; 
            }
            @media (max-width: 450px) {
            .h-custom {
            height: 100%;
            }
            }
            .error-message {
                color: #dc3545; /* Bootstrap's danger color */
                font-size: 0.875em;
                margin-top: 0.25rem;
                text-align: left;
                min-height: 1.2em;
            }

            @keyframes slideInRight {
                from { transform: translateX(50px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes zoomPan {
                0% { background-size: 110% auto; background-position: 0% 50%; }
                100% { background-size: 120% auto; background-position: 100% 50%; }
            }

            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
            
            .form-control.is-invalid {
                animation: shake 0.3s ease;
            }
            
            .col-xl-4 {
                animation: slideInRight 0.8s ease-out forwards;
                background: rgba(255, 255, 255, 0.95);
                padding: 2rem;
                border-radius: 1rem;
                box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            }
            
            .form-outline {
                position: relative;
            }
            .form-outline .form-control {
                padding-top: 1.5rem;
                padding-bottom: 0.5rem;
            }
            .form-outline .form-label {
                position: absolute;
                top: 50%;
                left: 1rem;
                transform: translateY(-50%);
                color: #6c757d;
                transition: all 0.2s ease-out;
                pointer-events: none;
                background-color: transparent;
            }
            .form-outline .form-control:focus + .form-label,
            .form-outline .form-control:not(:placeholder-shown) + .form-label {
                top: 0.75rem;
                transform: translateY(-50%) scale(0.85);
                color: #0d6efd;
                background-color: #fff; /* Match form background */
                padding: 0 0.25rem;
            }
        </style>
    </head>
    <body>
        <section class="vh-100">
            <div class="container-fluid h-custom">
                <div class="row d-flex justify-content-center align-items-center h-100">
                    <div class="col-md-8 col-lg-6 col-xl-4">
                        <form id="loginForm" novalidate>
                            <div class="text-center mb-4">
                                <h3 class="fw-bold">Admin Portal Login</h3>
                                <p class="text-muted">Please sign in to continue</p>
                            </div>
                           
                            <div class="form-outline mb-4">
                                <input type="email" id="emailInput" class="form-control form-control-lg"
                                placeholder=" "/> <label class="form-label" for="emailInput">Email address</label>
                                <div id="emailError" class="error-message"></div>
                            </div>

                            <div class="form-outline mb-3">
                                <input type="password" id="passwordInput" class="form-control form-control-lg"
                                placeholder=" "/> <label class="form-label" for="passwordInput">Password</label>
                                <div id="passwordError" class="error-message"></div>
                            </div>

                            <div id="authError" class="error-message text-center fw-bold mb-3"></div>

                            <div class="d-flex justify-content-end align-items-center">
                                <a href="forgotpass.html" class="text-body">Forgot password?</a>
                            </div>

                            <div class="text-center text-lg-start mt-4 pt-2">
                                <button id="submitBtn" type="submit" class="btn btn-primary btn-lg w-100"
                                style="padding-left: 2.5rem; padding-right: 2.5rem;">Login</button>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </section>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <!-- START: FIREBASE INTEGRATION -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
            import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
            import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

            const firebaseConfig = {
                apiKey: "AIzaSyDxkvvObHv2IuKMKlp81WVsAtm75gkWB0Y",
                authDomain: "studentportal-eb425.firebaseapp.com",
                projectId: "studentportal-eb425",
                storageBucket: "studentportal-eb425.appspot.com",
                messagingSenderId: "1021027397198",
                appId: "1:1021027397198:web:7195716ef430ebfb359d1f"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            const loginForm = document.getElementById('loginForm');
            const emailInput = document.getElementById('emailInput');
            const passwordInput = document.getElementById('passwordInput');
            const emailError = document.getElementById('emailError');
            const passwordError = document.getElementById('passwordError');
            const authError = document.getElementById('authError');
            const submitBtn = document.getElementById('submitBtn');

            function clearErrors() {
                emailError.textContent = '';
                passwordError.textContent = '';
                authError.textContent = '';
                emailInput.classList.remove('is-invalid');
                passwordInput.classList.remove('is-invalid');
            }
            
            loginForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                clearErrors();

                let isValid = true;
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();
                if (email === '') {
                    emailError.textContent = 'Please enter a valid email address.';
                    emailInput.classList.add('is-invalid');
                    isValid = false;
                }
                if (password.length < 6) {
                    passwordError.textContent = 'Password must be at least 6 characters long.';
                    passwordInput.classList.add('is-invalid');
                    isValid = false;
                }
                if (!isValid) return;

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Verifying...';
                
                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // ADMIN CHECK
                    const adminRef = doc(db, "admins", user.uid);
                    const adminSnap = await getDoc(adminRef);

                    if (adminSnap.exists()) {
                        console.log('Admin Login Success!', user);
                        window.location.href = `${window.location.origin}/admin.html`;
                    } else {
                        // Not an admin
                        console.log('User is not an admin. Signing out.');
                        await signOut(auth); // Log them out immediately
                        authError.textContent = 'Access Denied. You do not have admin privileges.';
                    }

                } catch (error) {
                    handleAuthError(error);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Login';
                }
            });

            function handleAuthError(error) {
                console.error("Authentication Error:", error.code, error.message);
                switch (error.code) {
                    case 'auth/invalid-login-credentials':
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        authError.textContent = 'Invalid email or password.';
                        break;
                    default:
                        authError.textContent = 'An unexpected error occurred. Please try again.';
                }
            }
        </script>
        <!-- END: FIREBASE INTEGRATION -->
    </body>
</html>
