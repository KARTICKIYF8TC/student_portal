<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Teacher Dashboard - Student Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --background-dark: #0D1117;
      --panel-glass-bg: rgba(22, 27, 34, 0.8); 
      --text-primary: #f0f6fc; 
      --text-secondary: #dee2e6; 
      --accent-start: #17A2B8;
      --accent-end: #17A2B8;
      --border-glow: rgba(23, 162, 184, 0.5);
      --border-color: rgba(255, 255, 255, 0.1);
      --mouse-x: 50%;
      --mouse-y: 50%;
    }
    body { 
      font-family: 'Inter', system-ui, sans-serif;
      color: var(--text-primary);
      background: 
        radial-gradient(circle at top left, rgba(23, 162, 184, 0.15) 0%, transparent 40%),
        radial-gradient(circle at bottom right, rgba(23, 162, 184, 0.12) 0%, transparent 50%),
        var(--background-dark);
      background-attachment: fixed;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }
    body::after {
        content: '';
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: radial-gradient(600px circle at var(--mouse-x) var(--mouse-y), rgba(23, 162, 184, 0.1), transparent 80%);
        z-index: -1;
        pointer-events: none;
    }
    .main-container {
        display: flex;
        flex-grow: 1;
    }
    .main-container > .row {
        flex-grow: 1;
    }
    .sidebar, .offcanvas {
      background: var(--panel-glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: var(--text-primary);
      border-right: 1px solid var(--border-color);
    }
    .sidebar a {
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: .5rem;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .sidebar a.active, .sidebar a:hover {
      background: rgba(23, 162, 184, 0.15);
      color: #fff;
    }
    #mainNavbar {
      background: var(--panel-glass-bg) !important;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    #page-title, #user-name, h1, h2, h3, h4, h5, h6, .card-text {
        color: var(--text-primary) !important;
    }
    .text-muted, .text-secondary {
        color: var(--text-secondary) !important;
    }
    .form-label {
      color: var(--text-primary) !important;
    }
    .breadcrumb-item a {
        color: var(--accent-start) !important;
        text-decoration: none;
    }
    .breadcrumb-item.active {
        color: var(--text-primary) !important;
    }

    .card {
      background: var(--panel-glass-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 30px rgba(0,0,0,.4), 0 0 15px var(--border-glow);
    }
    .form-control, .form-select {
      background-color: rgba(0,0,0,0.2);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    .form-control:focus, .form-select:focus {
      background-color: rgba(0,0,0,0.2);
      border-color: var(--accent-start);
      color: var(--text-primary);
      box-shadow: 0 0 0 0.25rem rgba(23, 162, 184, 0.25);
    }
    .form-control:disabled {
        background-color: rgba(0,0,0,0.2);
        opacity: 0.7;
    }
    .form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23f0f6fc' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
    }

    /* --- THIS IS THE FIX --- */
    .form-select option {
      background-color: #fff;
      color: #0D1117;
    }
    /* --- END OF FIX --- */

    .btn-primary {
      border-radius: 8px;
      font-weight: 600;
      border: 2px solid var(--accent-start);
      background: transparent;
      color: var(--accent-start);
      transition: all 0.3s ease;
    }
    .btn-primary:hover, .btn-primary:focus {
      background: linear-gradient(90deg, var(--accent-start), var(--accent-end));
      color: #fff;
      border-color: transparent;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
    }
    .btn-outline-secondary {
        color: var(--text-secondary);
        border-color: var(--border-color);
    }
    .btn-outline-secondary:hover {
        background-color: var(--border-color);
        color: var(--text-primary);
    }
    .btn-danger {
        background-color: #dc3545;
        border: none;
    }
    .avatar {
      width: 40px; height: 40px; object-fit: cover; border-radius: 50%;
      border: 2px solid var(--border-color);
    }
    .profile-avatar {
        width: 120px; height: 120px;
        object-fit: cover; border-radius: 50%;
        border: 4px solid var(--accent-start);
        box-shadow: 0 4px 12px rgba(0,0,0,.1);
    }
    
    .grade-item {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        padding: 1rem;
        border: 1px solid var(--border-color);
        border-radius: .5rem;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
    }
    .calendar-day, .calendar-day-name {
        text-align: center;
        padding: 0.75rem 0.25rem;
        border-radius: 8px;
    }
    .calendar-day {
        color: white;
    }
    .calendar-day-name {
        font-weight: 600;
        color: var(--text-secondary);
    }
    .calendar-day.is-present { background-color: rgba(40, 167, 69, 0.7); color: white; }
    .calendar-day.is-absent { background-color: rgba(220, 53, 69, 0.7); color: white; }
    .calendar-day.is-holiday { background-color: rgba(255, 193, 7, 0.7); color: black; }
    .calendar-day.is-late { background-color: rgba(13, 110, 253, 0.7); color: white; }
    .calendar-day.is-today {
        box-shadow: 0 0 0 2px var(--accent-start);
    }
    .legend {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 1.5rem;
        margin-top: 1.5rem;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #page-content .card, #page-content .row > [class*="col-"], #page-content .table-responsive {
      opacity: 0;
      animation: fadeInUp 0.6s ease-out forwards;
    }
    #page-content .row > [class*="col-"]:nth-child(1) { animation-delay: 0.1s; }
    #page-content .row > [class*="col-"]:nth-child(2) { animation-delay: 0.2s; }
    #page-content .row > [class*="col-"]:nth-child(3) { animation-delay: 0.3s; }
  </style>
</head>
<body>
  
  <nav id="mainNavbar" class="navbar navbar-expand-md sticky-top">
    <div class="container-fluid">
      <button class="btn d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas" aria-label="Toggle navigation">
        <i class="bi bi-list fs-3 text-white"></i>
      </button>
      <span class="navbar-brand mb-0 h1" id="page-title">Dashboard</span>
      <div class="d-flex align-items-center gap-2">
        <a href="#/profile" class="text-decoration-none d-flex align-items-center gap-2">
          <img src="https://placehold.co/40x40/EFEFEF/333333?text=?" alt="Profile" class="avatar" id="user-avatar">
          <span class="fw-semibold d-none d-sm-inline" id="user-name">Loading...</span>
        </a>
      </div>
    </div>
  </nav>

  <div class="container-fluid main-container">
    <div class="row">
      <aside class="col-md-3 col-lg-2 d-none d-md-block sidebar px-3">
        <div class="py-4 d-flex align-items-center gap-2">
          <img src="https://img.icons8.com/ios-filled/50/ffffff/teacher.png" alt="Logo" style="width: 40px;">
          <h5 class="mb-0">Teacher Panel</h5>
        </div>
        <nav class="nav flex-column gap-1 pb-4" id="desktop-nav">
          <a class="nav-link px-3 py-2 active" href="#/dashboard"><i class="bi bi-house-door me-2"></i>Dashboard</a>
          <a class="nav-link px-3 py-2" href="#/students"><i class="bi bi-people me-2"></i>My Students</a>
          <a class="nav-link px-3 py-2" href="#/manage-grades"><i class="bi bi-pencil-square me-2"></i>Manage Grades</a>
          <a class="nav-link px-3 py-2" href="#/view-attendance"><i class="bi bi-calendar-check me-2"></i>View Attendance</a>
          <a class="nav-link px-3 py-2" href="#/announcements"><i class="bi bi-megaphone me-2"></i>Announcements</a>
          <a class="nav-link px-3 py-2" href="#/profile"><i class="bi bi-person-circle me-2"></i>Profile</a>
          <a class="nav-link px-3 py-2" href="#" id="logout-btn"><i class="bi bi-box-arrow-right me-2"></i>Logout</a>
        </nav>
      </aside>

      <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas" aria-labelledby="sidebarLabel">
        <div class="offcanvas-header">
          <div class="d-flex align-items-center gap-2">
            <img src="https://img.icons8.com/ios-filled/50/ffffff/teacher.png" alt="Logo" style="width: 40px;">
            <h5 class="offcanvas-title" id="sidebarLabel">Teacher Panel</h5>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body sidebar pt-0">
          <nav class="nav flex-column gap-1" id="mobile-nav">
            <a class="nav-link px-3 py-2 active" href="#/dashboard"><i class="bi bi-house-door me-2"></i>Dashboard</a>
            <a class="nav-link px-3 py-2" href="#/students"><i class="bi bi-people me-2"></i>My Students</a>
            <a class="nav-link px-3 py-2" href="#/manage-grades"><i class="bi bi-pencil-square me-2"></i>Manage Grades</a>
            <a class="nav-link px-3 py-2" href="#/view-attendance"><i class="bi bi-calendar-check me-2"></i>View Attendance</a>
            <a class="nav-link px-3 py-2" href="#/announcements"><i class="bi bi-megaphone me-2"></i>Announcements</a>
            <a class="nav-link px-3 py-2" href="#/profile"><i class="bi bi-person-circle me-2"></i>Profile</a>
            <a class="nav-link px-3 py-2" href="#" id="logout-btn-mobile"><i class="bi bi-box-arrow-right me-2"></i>Logout</a>
          </nav>
        </div>
      </div>

      <main class="col-md-9 col-lg-10 ms-sm-auto px-3 px-md-4 py-4" id="page-content">
          </main>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, onSnapshot, getDocs, where, Timestamp, addDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDxkvvObHv2IuKMKlp81WVsAtm75gkWB0Y",
        authDomain: "studentportal-eb425.firebaseapp.com",
        projectId: "studentportal-eb425",
        storageBucket: "studentportal-eb425.appspot.com",
        messagingSenderId: "1021027397198",
        appId: "1:1021027397198:web:7195716ef430ebfb359d1f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const pageContent = document.getElementById('page-content');
    const pageTitle = document.getElementById('page-title');
    let currentUser = null;
    let currentMentorData = null; 
    
    const loaderHTML = `
        <div class="d-flex justify-content-center align-items-center" style="height: 60vh;">
            <div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--accent-start);" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>`;
    
    const gradeToPoints = (grade) => ({'A': 10, 'B': 8, 'C': 6, 'D': 4, 'F': 0}[grade] || 0);

    const mobileNavLinks = document.querySelectorAll('#mobile-nav a');
    const sidebarOffcanvasEl = document.getElementById('sidebarOffcanvas');
    const sidebar = new bootstrap.Offcanvas(sidebarOffcanvasEl);
    mobileNavLinks.forEach(link => {
        link.addEventListener('click', () => {
            sidebar.hide();
        });
    });
    
    const renderTeacherDashboard = async (user, params) => {
        const studentsRef = collection(db, "studentData");
        const q = query(studentsRef, where("mentorId", "==", user.uid));
        const querySnapshot = await getDocs(q);
        const studentCount = querySnapshot.size; 

        pageContent.innerHTML = `
            <div class="row g-4">
              <div class="col-12">
                <div class="card h-100">
                  <div class="card-body p-4">
                    <h5 class="card-title mb-2">Welcome Back, ${currentMentorData.name || user.email.split('@')[0]}!</h5>
                    <p class="card-text mb-0 text-muted">You are currently mentoring <strong>${studentCount}</strong> ${studentCount === 1 ? 'student' : 'students'}.</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="row g-4 mt-1">
              <div class="col-md-6">
                <div class="card h-100">
                  <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center">
                      <h5 class="card-title mb-0">View Your Students</h5>
                      <i class="bi bi-people fs-4 text-secondary"></i>
                    </div>
                    <p class="mt-2 mb-3 text-muted">Review your assigned students' progress and details.</p>
                    <a href="#/students" class="btn btn-primary mt-auto">View Student List</a>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card h-100">
                  <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center">
                      <h5 class="card-title mb-0">Post an Update</h5>
                      <i class="bi bi-megaphone fs-4 text-secondary"></i>
                    </div>
                    <p class="mt-2 mb-3 text-muted">Share an announcement with all students.</p>
                    <a href="#/announcements" class="btn btn-primary mt-auto">Post Announcement</a>
                  </div>
                </div>
              </div>
            </div>`;
    };

    const renderStudents = async (user, params) => {
        const studentsRef = collection(db, "studentData");
        const q = query(studentsRef, where("mentorId", "==", user.uid));
        
        const querySnapshot = await getDocs(q);
        
        let studentsHTML = '';
        if (querySnapshot.empty) {
            studentsHTML = '<div class="col-12"><div class="card"><div class="card-body text-center">You have not been assigned any students yet.</div></div></div>';
        } else {
            studentsHTML = querySnapshot.docs.map(doc => {
                const student = doc.data();
                return `
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex align-items-center gap-3">
                                <img src="${student.photoBase64 || 'https://placehold.co/60x60'}" class="rounded-circle" style="width: 60px; height: 60px; object-fit: cover;">
                                <div>
                                    <h5 class="card-title mb-0">${student.displayName || 'N/A'}</h5>
                                    <p class="card-text text-muted mb-0" style="word-break: break-all;">${student.email}</p>
                                </div>
                            </div>
                            <small class="d-block text-center my-3" style="color: var(--accent-start);">Attendance: ${student.attendance || 0}% | SGPA: ${student.sgpa || '0.0'}</small>
                            <a href="#/manage-grades?studentId=${doc.id}&studentName=${encodeURIComponent(student.displayName)}" class="btn btn-primary mt-auto">Manage Grades</a>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        pageContent.innerHTML = `
            <h1 class="mb-4">My Students</h1>
            <div id="students-container" class="row g-4">${studentsHTML}</div>`;
    };

    const renderManageGrades = async (user, params) => {
        const studentId = params.get('studentId');
        let studentName = params.get('studentName');

        if (!studentId) {
            pageContent.innerHTML = `<h1 class="mb-4">Manage Grades</h1><p class="lead text-muted">Select a student to manage their grades.</p><div class="row g-4">${loaderHTML}</div>`;
            const studentsRef = collection(db, "studentData");
            const q = query(studentsRef, where("mentorId", "==", user.uid));
            const querySnapshot = await getDocs(q);
            
            let studentsHTML = '';
            if (querySnapshot.empty) {
                studentsHTML = '<div class="col-12"><div class="card"><div class="card-body text-center">You have not been assigned any students yet.</div></div></div>';
            } else {
                studentsHTML = querySnapshot.docs.map(doc => {
                    const student = doc.data();
                    return `
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex align-items-center gap-3">
                                    <img src="${student.photoBase64 || 'https://placehold.co/60x60'}" class="rounded-circle" style="width: 60px; height: 60px; object-fit: cover;">
                                    <div>
                                        <h5 class="card-title mb-0">${student.displayName || 'N/A'}</h5>
                                        <p class="card-text text-muted mb-0" style="word-break: break-all;">${student.email}</p>
                                    </div>
                                </div>
                                <a href="#/manage-grades?studentId=${doc.id}&studentName=${encodeURIComponent(student.displayName)}" class="btn btn-primary mt-auto">Manage Grades</a>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
            pageContent.querySelector('.row').innerHTML = studentsHTML;
            return;
        }

        pageContent.innerHTML = `
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#/manage-grades">Manage Grades</a></li>
                <li class="breadcrumb-item active" aria-current="page">${studentName}</li>
              </ol>
            </nav>
            <h1 class="mb-4">Manage Grades for <span style="color: var(--accent-start);">${studentName}</span></h1>
            <div class="card">
                <div class="card-body p-4">
                    <div id="grade-editor">
                        <div id="grade-list" class="vstack gap-3">
                            ${loaderHTML}
                        </div>
                        <button type="button" class="btn btn-outline-secondary mt-3" id="add-grade-btn">
                            <i class="bi bi-plus-circle me-1"></i>Add Course Grade
                        </button>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-end gap-2" style="background-color: transparent; border-top: 1px solid var(--border-color);">
                    <div id="save-alert" class="me-auto d-flex align-items-center"></div>
                    <button type="button" class="btn btn-primary" id="save-grade-changes">
                        <i class="bi bi-save me-1"></i> Save Changes
                    </button>
                </div>
            </div>
        `;

        const gradeList = document.getElementById('grade-list');
        const gradeOptions = ['A', 'B', 'C', 'D', 'F'].map(g => `<option value="${g}">${g}</option>`).join('');

        const createGradeItem = (grade = { courseName: '', courseCode: '', creditHours: 0, grade: 'A' }) => {
            const item = document.createElement('div');
            item.className = 'grade-item';
            item.innerHTML = `
                <div class="flex-grow-1 row g-2">
                    <div class="col-lg-4">
                        <label class="form-label small">Course Name</label>
                        <input type="text" class="form-control" data-field="courseName" placeholder="e.g., Intro to CS" value="${grade.courseName}">
                    </div>
                    <div class="col-lg-3">
                        <label class="form-label small">Course Code</label>
                        <input type="text" class="form-control" data-field="courseCode" placeholder="e.g., CS101" value="${grade.courseCode}">
                    </div>
                    <div class="col-lg-3 col-6">
                        <label class="form-label small">Credits</label>
                        <input type="number" class="form-control" data-field="creditHours" placeholder="Credits" value="${grade.creditHours}">
                    </div>
                    <div class="col-lg-2 col-6">
                         <label class="form-label small">Grade</label>
                        <select class="form-select" data-field="grade"></select>
                    </div>
                </div>
                <button type="button" class="btn btn-danger btn-sm remove-item-btn" style="height: fit-content; margin-top: 28px;">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            const selectEl = item.querySelector('[data-field="grade"]');
            selectEl.innerHTML = gradeOptions;
            selectEl.value = grade.grade;

            item.querySelector('.remove-item-btn').onclick = () => item.remove();
            return item;
        };
        
        const gradesRef = doc(db, "studentGrades", studentId);
        const gradesSnap = await getDoc(gradesRef);
        gradeList.innerHTML = ''; 
        
        if (gradesSnap.exists() && gradesSnap.data().grades && gradesSnap.data().grades.length > 0) {
            gradesSnap.data().grades.forEach(grade => gradeList.appendChild(createGradeItem(grade)));
        } else {
            gradeList.appendChild(createGradeItem()); 
        }

        document.getElementById('add-grade-btn').onclick = () => {
            gradeList.appendChild(createGradeItem());
        };

        document.getElementById('save-grade-changes').onclick = async () => {
            const saveBtn = document.getElementById('save-grade-changes');
            const alertContainer = document.getElementById('save-alert');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
            alertContainer.innerHTML = '';
            
            try {
                const grades = [];
                let totalCredits = 0, totalPoints = 0;
                
                document.querySelectorAll('#grade-list .grade-item').forEach(item => {
                    const courseName = item.querySelector('[data-field="courseName"]').value;
                    const creditHours = Number(item.querySelector('[data-field="creditHours"]').value) || 0;
                    const grade = item.querySelector('[data-field="grade"]').value;
                    
                    if (courseName && creditHours > 0) {
                         const gradeData = {
                            courseName: courseName,
                            courseCode: item.querySelector('[data-field="courseCode"]').value,
                            creditHours: creditHours,
                            grade: grade,
                        };
                        grades.push(gradeData);
                        
                        totalCredits += creditHours;
                        totalPoints += creditHours * gradeToPoints(grade);
                    }
                });

                const sgpa = totalCredits > 0 ? (totalPoints / totalCredits).toFixed(2) : 0.00;

                await updateDoc(gradesRef, { grades: grades });
                
                const studentDataRef = doc(db, "studentData", studentId);
                await updateDoc(studentDataRef, { sgpa: Number(sgpa), credits: totalCredits });
                
                alertContainer.innerHTML = `<span class="text-success">Saved Successfully!</span>`;
                setTimeout(() => alertContainer.innerHTML = '', 3000);

            } catch (error) {
                console.error("Error saving grades: ", error);
                alertContainer.innerHTML = `<span class="text-danger">Error: ${error.message}</span>`;
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-save me-1"></i> Save Changes';
            }
        };
    };
    
    const renderViewAttendance = async (user, params) => {
        const studentId = params.get('studentId');
        let studentName = params.get('studentName');

        if (!studentId) {
            pageContent.innerHTML = `<h1 class="mb-4">View Attendance</h1><p class="lead text-muted">Select a student to view their attendance record.</p><div class="row g-4">${loaderHTML}</div>`;
            const studentsRef = collection(db, "studentData");
            const q = query(studentsRef, where("mentorId", "==", user.uid));
            const querySnapshot = await getDocs(q);
            
            let studentsHTML = '';
            if (querySnapshot.empty) {
                studentsHTML = '<div class="col-12"><div class="card"><div class="card-body text-center">You have not been assigned any students yet.</div></div></div>';
            } else {
                studentsHTML = querySnapshot.docs.map(doc => {
                    const student = doc.data();
                    return `
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex align-items-center gap-3">
                                    <img src="${student.photoBase64 || 'https://placehold.co/60x60'}" class="rounded-circle" style="width: 60px; height: 60px; object-fit: cover;">
                                    <div>
                                        <h5 class="card-title mb-0">${student.displayName || 'N/A'}</h5>
                                        <p class="card-text text-muted mb-0" style="word-break: break-all;">${student.email}</p>
                                    </div>
                                </div>
                                <a href="#/view-attendance?studentId=${doc.id}&studentName=${encodeURIComponent(student.displayName)}" class="btn btn-primary mt-auto">View Attendance</a>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
            pageContent.querySelector('.row').innerHTML = studentsHTML;
            return;
        }
        
        pageContent.innerHTML = `
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#/view-attendance">View Attendance</a></li>
                <li class="breadcrumb-item active" aria-current="page">${studentName}</li>
              </ol>
            </nav>
            <h1 class="mb-4">Attendance for <span style="color: var(--accent-start);">${studentName}</span></h1>
            <div id="monthly-stats-container" class="mb-4"></div>
            <div class="card">
                <div class="card-body p-lg-4" id="calendar-container">
                    ${loaderHTML}
                </div>
            </div>`;

        let attendanceData = {};
        let holidayData = {};

        try {
            const attendanceRef = doc(db, "studentAttendance", studentId);
            const holidayRef = doc(db, "globalData", "holidays");
            
            const [attendanceSnap, holidaySnap] = await Promise.all([
                getDoc(attendanceRef),
                getDoc(holidayRef)
            ]);

            if (attendanceSnap.exists()) {
                attendanceData = attendanceSnap.data().records || {};
            }
            if (holidaySnap.exists()) {
                holidayData = holidaySnap.data().dates || {};
            }
        } catch (error) {
            console.error("Error fetching attendance data:", error);
            pageContent.innerHTML = `<div class="alert alert-danger">Error loading attendance data.</div>`;
            return;
        }

        let currentDate = new Date();

        const generateCalendar = (year, month) => {
            const container = document.getElementById('calendar-container');
            if (!container) return;

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayIndex = firstDay.getDay();

            let monthPresent = 0;
            let monthWorkingDays = 0;
            const today = new Date();
            today.setHours(0,0,0,0);

            for (let day = 1; day <= daysInMonth; day++) {
                const loopDate = new Date(year, month, day);
                 if (loopDate > today) break;

                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                if (holidayData[dateString]) continue;

                const status = attendanceData[dateString];
                if (status === 'present' || status === 'absent' || status === 'late') {
                    monthWorkingDays++;
                    if (status === 'present' || status === 'late') {
                        monthPresent++;
                    }
                }
            }
            
            const monthlyPercentage = monthWorkingDays > 0 ? Math.round((monthPresent / monthWorkingDays) * 100) : 'N/A';
            const statsContainer = document.getElementById('monthly-stats-container');
            statsContainer.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title text-center mb-0">Attendance for ${monthNames[month]} ${year}: <span class="fw-bold" style="color: var(--accent-start);">${monthlyPercentage}${monthlyPercentage !== 'N/A' ? '%' : ''}</span></h5>
                    </div>
                </div>`;


            let calendarHTML = `
                <div class="calendar-header">
                    <button id="prev-month" class="btn btn-outline-secondary">&lt;</button>
                    <h4 class="mb-0">${monthNames[month]} ${year}</h4>
                    <button id="next-month" class="btn btn-outline-secondary">&gt;</button>
                </div>
                <div class="calendar-grid">
                    ${dayNames.map(day => `<div class="calendar-day-name">${day}</div>`).join('')}
            `;

            for (let i = 0; i < startDayIndex; i++) {
                calendarHTML += `<div></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const loopDate = new Date(year, month, day);
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const status = attendanceData[dateString];
                let dayClass = 'calendar-day';

                if (holidayData[dateString]) {
                    dayClass += ' is-holiday';
                } else if (status === 'present') {
                    dayClass += ' is-present';
                } else if (status === 'absent') {
                    dayClass += ' is-absent';
                } else if (status === 'late') {
                    dayClass += ' is-late';
                }
                
                if (loopDate.getTime() === today.getTime()) {
                    dayClass += ' is-today';
                }

                calendarHTML += `<div class="${dayClass}">${day}</div>`;
            }

            calendarHTML += `</div>
                <div class="legend">
                    <div class="legend-item"><span class="legend-color" style="background-color: rgba(40, 167, 69, 0.7);"></span> Present</div>
                    <div class="legend-item"><span class="legend-color" style="background-color: rgba(220, 53, 69, 0.7);"></span> Absent</div>
                    <div class="legend-item"><span class="legend-color" style="background-color: rgba(13, 110, 253, 0.7);"></span> Late</div>
                    <div class="legend-item"><span class="legend-color" style="background-color: rgba(255, 193, 7, 0.7);"></span> Holiday</div>
                </div>
            `;
            container.innerHTML = calendarHTML;

            document.getElementById('prev-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
            });
            document.getElementById('next-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
            });
        };
        
        generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
    };

    const renderTeacherProfile = async (user, params) => {
        const photo = currentMentorData?.photoBase64 || 'https://placehold.co/120x120/EFEFEF/333333?text=?';

        pageContent.innerHTML = `
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-body p-4">
                            <h2 class="mb-4">Edit Profile</h2>
                            <form id="profile-form">
                                <div class="text-center mb-4">
                                    <img src="${photo}" alt="Profile" class="profile-avatar" id="profile-img-preview">
                                </div>
                                <div class="mb-3">
                                    <label for="displayName" class="form-label">Display Name</label>
                                    <input type="text" class="form-control" id="displayName" value="${currentMentorData.name || ''}" placeholder="Enter your full name">
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="email" value="${user.email}" disabled>
                                </div>
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="phone" value="${currentMentorData.phone || ''}" placeholder="Enter your phone number">
                                </div>
                                <div class="mb-3">
                                    <label for="photoUpload" class="form-label">Change Profile Picture</label>
                                    <input class="form-control" type="file" id="photoUpload" accept="image/png, image/jpeg">
                                </div>
                                <div id="alert-container"></div>
                                <button type="submit" class="btn btn-primary w-100" id="save-profile-btn">
                                    Save Changes
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>`;
        
        const profileForm = document.getElementById('profile-form');
        const displayNameInput = document.getElementById('displayName');
        const phoneInput = document.getElementById('phone');
        const photoUploadInput = document.getElementById('photoUpload');
        const saveBtn = document.getElementById('save-profile-btn');
        const alertContainer = document.getElementById('alert-container');
        const imgPreview = document.getElementById('profile-img-preview');
        let newPhotoBase64 = null;

        photoUploadInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 400, MAX_HEIGHT = 400;
                        let { width, height } = img;
                        if (width > height) {
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        } else {
                            if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                        }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        newPhotoBase64 = canvas.toDataURL('image/jpeg', 0.9);
                        imgPreview.src = newPhotoBase64; 
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
            alertContainer.innerHTML = '';
            
            try {
                const mentorRef = doc(db, "mentors", user.uid);
                const updates = { 
                    name: displayNameInput.value,
                    phone: phoneInput.value
                };
                if (newPhotoBase64) {
                    updates.photoBase64 = newPhotoBase64;
                }
                
                await setDoc(mentorRef, updates, { merge: true });
                await updateProfile(auth.currentUser, { displayName: displayNameInput.value });

                currentMentorData = { ...currentMentorData, ...updates };
                document.getElementById('user-name').textContent = updates.name;
                if (updates.photoBase64) {
                    document.getElementById('user-avatar').src = updates.photoBase64;
                }

                alertContainer.innerHTML = '<div class="alert alert-success" style="background-color: rgba(23, 162, 184, 0.1); border-color: var(--accent-start); color: var(--text-primary);">Profile updated successfully!</div>';
                newPhotoBase64 = null; 

            } catch (error) {
                console.error("Profile Update Error: ", error);
                alertContainer.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'Save Changes';
            }
        });
    };
    
    const renderAnnouncements = async (user, params) => {
        pageContent.innerHTML = `
            <div class="row">
                <div class="col-lg-8">
                    <h1 class="mb-4">Post Announcement</h1>
                    <div class="card mb-4">
                        <div class="card-body">
                            <form id="add-notice-form">
                                <div class="mb-3">
                                    <label for="notice-text" class="form-label">New Announcement</label>
                                    <textarea class="form-control" id="notice-text" rows="4" required placeholder="Type your message to all students..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary" id="save-new-notice">
                                    <i class="bi bi-send me-2"></i>Post Notice
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-lg-10">
                    <h2 class="mb-4">Posted Announcements</h2>
                    <div id="announcements-container" class="vstack gap-3">
                        ${loaderHTML}
                    </div>
                </div>
            </div>`;
            
        const container = document.getElementById('announcements-container');
        const q = query(collection(db, "notices"), orderBy("timestamp", "desc"));
        
        onSnapshot(q, (querySnapshot) => {
            container.innerHTML = ''; 
            if (querySnapshot.empty) {
                container.innerHTML = '<div class="card"><div class="card-body text-muted">No announcements found.</div></div>';
                return;
            }
            querySnapshot.forEach((doc) => {
                const notice = doc.data();
                const postDate = notice.timestamp.toDate();
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-body">
                        <p class="card-text fs-5">${notice.text}</p>
                        <small class="text-muted">Posted by ${notice.authorName || 'Admin'} on ${postDate.toLocaleDateString()}</small>
                    </div>`;
                container.appendChild(card);
            });
        }, (error) => {
            console.error(error);
            container.innerHTML = '<div class="alert alert-danger">Error loading announcements.</div>';
        });

        const addNoticeForm = document.getElementById('add-notice-form');
        addNoticeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const noticeText = document.getElementById('notice-text').value;
            const saveBtn = document.getElementById('save-new-notice');
            if (!noticeText.trim()) return;

            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Posting...';
            try {
                await addDoc(collection(db, 'notices'), { 
                    text: noticeText, 
                    timestamp: Timestamp.now(),
                    authorName: currentMentorData.name || user.email,
                    authorId: user.uid
                });
                addNoticeForm.reset();
            } catch (error) {
                console.error("Error adding notice:", error);
                alert("Error: " + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-send me-2"></i>Post Notice';
            }
        });
    };
    
    const routes = {
        '/dashboard': { title: 'Dashboard', render: renderTeacherDashboard },
        '/students': { title: 'My Students', render: renderStudents },
        '/manage-grades': { title: 'Manage Grades', render: renderManageGrades },
        '/view-attendance': { title: 'View Attendance', render: renderViewAttendance },
        '/announcements': { title: 'Announcements', render: renderAnnouncements },
        '/profile': { title: 'Profile', render: renderTeacherProfile },
    };

    const router = async () => {
        const fullHash = window.location.hash.substring(1);
        const [path, queryString] = fullHash.split('?');
        const params = new URLSearchParams(queryString || '');
        
        const route = routes[path] || routes['/dashboard'];
        
        pageTitle.textContent = route.title;
        pageContent.innerHTML = loaderHTML; 
        
        if(currentUser) {
            await route.render(currentUser, params);
        }

        document.querySelectorAll('#desktop-nav a, #mobile-nav a').forEach(a => {
            a.classList.remove('active');
            if (a.getAttribute('href').startsWith(`#${path}`)) { 
                a.classList.add('active'); 
            }
        });
    };

    window.addEventListener('hashchange', router);
    
    window.addEventListener('load', () => { 
        if (!window.location.hash) { 
            window.location.hash = '#/dashboard'; 
        } else {
            router(); 
        }
    });

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const mentorRef = doc(db, "mentors", user.uid);
            const mentorSnap = await getDoc(mentorRef);

            if (mentorSnap.exists()) {
                currentUser = user;
                currentMentorData = mentorSnap.data();
                
                document.getElementById('user-name').textContent = currentMentorData.name || user.email.split('@')[0];
                if (currentMentorData.photoBase64) {
                    document.getElementById('user-avatar').src = currentMentorData.photoBase64;
                }

                router(); 
            } else {
                console.error("Access Denied. User is not a mentor.");
                await signOut(auth);
                window.location.href = 'index.html'; 
            }
        } else { 
            window.location.href = 'index.html'; 
        }
    });

    const handleLogout = () => { signOut(auth).then(() => { window.location.href = 'index.html'; }); };
    document.getElementById('logout-btn').addEventListener('click', handleLogout);
    document.getElementById('logout-btn-mobile').addEventListener('click', handleLogout);
  </script>

  <script>
    document.addEventListener('mousemove', (e) => {
      document.documentElement.style.setProperty('--mouse-x', `${e.clientX}px`);
      document.documentElement.style.setProperty('--mouse-y', `${e.clientY}px`);
    });
  </script>
</body>
</html>